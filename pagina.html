<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reproductor DBZ ‚Äî Pages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#f6f7fb; --ink:#2d2a32; --muted:#6b6a73; --panel:#ffffff; --edge:#e9e8f2; --accent:#b59bff; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--ink);
      background: radial-gradient(1000px 1000px at 10% -10%, #efeaff 0%, transparent 55%),
                 radial-gradient(900px 900px at 100% 0%, #e3fff7 0%, transparent 55%),
                 linear-gradient(180deg,var(--bg),#fdfcff 60%);
      display:flex; align-items:center; justify-content:center; padding:24px; }
    .player{ background:var(--panel); border:1px solid var(--edge); border-radius:22px; box-shadow:0 10px 30px rgba(23,15,41,.08); max-width:960px; width:100% }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px;
      background:linear-gradient(135deg, color-mix(in oklch,var(--accent), white 20%), color-mix(in oklch,var(--accent), black 8%)); color:#2b223d }
    .title{ margin:0; font-size:16px; font-weight:700; letter-spacing:.3px }
    .badge{ font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.65); border:1px solid rgba(0,0,0,.05) }

    .stage{ position:relative; background:#000 }
    video{ width:100%; height:auto; display:block; background:#000; position:relative; z-index:1 }
    .center-play{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none }
    .center-play .btn-big{ pointer-events:auto; --size:72px; width:var(--size); height:var(--size); border-radius:999px; border:none; display:grid; place-items:center; font-size:28px; color:white; background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.45)); box-shadow:0 10px 30px rgba(0,0,0,.2) }

    .controls{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:14px 16px; padding:14px 16px 12px }
    .row{ display:flex; align-items:center; gap:8px }
    .btn{ --size:40px; width:var(--size); height:var(--size); display:grid; place-items:center; border-radius:12px; border:1px solid var(--edge); background:linear-gradient(180deg,#fff,#fafafe); box-shadow:0 6px 16px rgba(23,15,41,.08); cursor:pointer; color:var(--ink) }
    .btn[aria-pressed="true"]{ outline:2px solid color-mix(in oklch,var(--accent),white 15%) }

    .seek{ grid-column:1/-1; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px }
    .time{ font-variant-numeric:tabular-nums; color:var(--muted); font-size:14px; min-width:70px; text-align:center }
    .range{ position:relative; height:22px; display:grid; align-items:center }
    .buffered,.progress{ pointer-events:none; position:absolute; left:0; height:4px; border-radius:999px }
    .buffered{ width:0%; background:#e8e7f4 } .progress{ width:0%; background:var(--accent) }
    input[type="range"].slider{-webkit-appearance:none; appearance:none; width:100%; height:4px; background:transparent; outline:none}
    input[type="range"].slider::-webkit-slider-thumb{-webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:white; border:2px solid var(--accent); box-shadow:0 2px 6px rgba(0,0,0,.12); margin-top:-6px}
    .vol{width:min(180px,25vw)}
    input[type="range"].vol-slider{-webkit-appearance:none; appearance:none; width:100%; height:4px; background:#efeef8; border-radius:999px}
    input[type="range"].vol-slider::-webkit-slider-thumb{ width:14px; height:14px; border-radius:50%; background:var(--accent) }

    .select{ padding:8px 10px; border-radius:12px; border:1px solid var(--edge); background:linear-gradient(180deg,#fff,#fafafe); color:var(--ink) }
    .foot{ color:var(--muted); font-size:13px; padding:0 16px 16px }

    /* Subt√≠tulos overlay */
    .captions{ position:absolute; left:0; right:0; bottom:6%; display:flex; flex-direction:column; gap:6px; align-items:center; padding:0 12px; z-index:5; pointer-events:auto }
    .cap-line{ max-width:min(86%, 900px); width:fit-content; color:#111; font-weight:600; letter-spacing:.2px; line-height:1.35; border-radius:14px; padding:8px 12px; box-shadow:0 6px 20px rgba(0,0,0,.16) }
    .track-ja{ background:rgba(255,255,255,.92) }
    .track-romaji{ background:rgba(255,245,232,.95) }
    .track-es{ background:rgba(236,253,245,.95) }

    .word-ja{ cursor:pointer; padding:0 2px; border-radius:6px }
    .word-ja:hover{ background:rgba(0,0,0,.06) }
    .track-romaji .word-ro{ pointer-events:none; cursor:default; padding:0 2px; border-radius:6px }
    .hl { outline:2px solid color-mix(in oklch,var(--accent),white 15%); background:rgba(181,155,255,.12); border-radius:6px }

    /* Popover (solo JA) */
    .popover{ position:absolute; z-index:10; min-width:240px; max-width:360px; background:#fff; border:1px solid var(--edge); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.15); padding:10px 12px; display:none }
    .popover .word{ font-weight:800; font-size:18px }
    .popover .hint{ color:var(--muted); font-size:12px; margin-top:4px }
    .popover .meaning{ margin-top:6px }

    .diag{ display:none } /* oculta diagn√≥stico para que no baje la p√°gina */
    .pill{ padding:4px 8px; border-radius:999px; border:1px solid var(--edge); background:#f7f7ff; white-space:nowrap }
    .tools{ display:flex; gap:8px; padding:0 16px 16px; flex-wrap:wrap }
    .tools .btn{ height:auto; padding:8px 12px; width:auto }

    ruby{ ruby-position:over; }
    rt{ font-size:.65em; color:#6b6a73 }
  </style>
</head>
<body>
  <div class="player" id="player">
    <div class="header">
      <h1 class="title">Proyecto integral ‚Äî Reproductor</h1>
      <span class="badge" id="badgeDur">00:00</span>
    </div>

    <div class="stage">
      <video id="video" preload="metadata" playsinline webkit-playsinline poster="poster.jpg">
        <source id="src" src="video.mp4" type="video/mp4" />
        <track id="trk-ja" label="Êó•Êú¨Ë™û"   kind="subtitles" srclang="ja"      src="subs-ja.vtt" default />
        <track id="trk-ro" label="R≈çmaji"  kind="subtitles" srclang="ja-Latn" src="subs-ro.vtt" />
        <track id="trk-es" label="Espa√±ol" kind="subtitles" srclang="es"      src="subs-es.vtt" />
      </video>

      <div class="center-play"><button class="btn-big" id="bigPlay" title="Reproducir">‚ñ∂</button></div>

      <div class="captions" id="captions">
        <div class="cap-line track-ja"     id="cap-ja" hidden></div>
        <div class="cap-line track-romaji" id="cap-romaji" hidden></div>
        <div class="cap-line track-es"     id="cap-es" hidden></div>
      </div>

      <div class="popover" id="popover">
        <div><span class="word" id="pv-word">‚Äî</span></div>
        <div class="hint" id="pv-reading"></div>
        <div class="meaning" id="pv-meaning"></div>
      </div>
    </div>

    <div class="controls" role="group" aria-label="Controles">
      <div class="row">
        <button class="btn" id="back10" title="Retroceder 10s">‚ü≤</button>
        <button class="btn" id="play"   title="Reproducir/Pausar"><span id="icon-play">‚ñ∂</span></button>
        <button class="btn" id="fwd10"  title="Avanzar 10s">‚ü≥</button>
      </div>
      <div class="row seek">
        <div class="time" id="currentTime">0:00</div>
        <div class="range">
          <div class="buffered" id="bufferedBar"></div>
          <div class="progress" id="progressBar"></div>
          <input id="seek" class="slider" type="range" min="0" max="1000" step="1" value="0" />
        </div>
        <div class="time" id="duration">0:00</div>
      </div>
      <div class="row">
        <button class="btn" id="mute" title="Silenciar/Activar">üîä</button>
        <div class="vol"><input id="volume" class="vol-slider" type="range" min="0" max="1" step="0.01" value="1" /></div>
      </div>
      <div class="row">
        <select id="speed" class="select" aria-label="Velocidad">
          <option value="0.5">0.5√ó</option><option value="0.75">0.75√ó</option><option value="1" selected>1√ó</option>
          <option value="1.25">1.25√ó</option><option value="1.5">1.5√ó</option><option value="1.75">1.75√ó</option><option value="2">2√ó</option>
        </select>
        <button class="btn" id="tog-ja"      aria-pressed="true">JA</button>
        <button class="btn" id="tog-romaji"  aria-pressed="false">RO</button>
        <button class="btn" id="tog-es"      aria-pressed="false">ES</button>
        <button class="btn" id="tog-fg"      aria-pressed="false" title="Furigana inline">FG</button>
        <button class="btn" id="fs"          title="Pantalla completa">‚§¢</button>
      </div>
    </div>

    <div class="tools">
      <button class="btn" id="btnTest">Probar video de prueba (MDN)</button>
      <button class="btn" id="btnURL">Cargar por URL‚Ä¶</button>
      <span class="pill" id="statusSrc">src: video.mp4</span>
      <span class="pill" id="pillJA">JA: ‚Äî</span>
      <span class="pill" id="pillRO">RO: ‚Äî</span>
      <span class="pill" id="pillES">ES: ‚Äî</span>
    </div>
    <div class="diag" id="diag"></div>
    <div class="foot">Atajos: Espacio ¬∑ ‚Üê/‚Üí ¬±5s ¬∑ ‚Üë/‚Üì volumen ¬∑ M mute ¬∑ F pantalla completa ¬∑ J/A/E alternar JA/RO/ES ¬∑ G furigana</div>
  </div>

  <script>
    (function(){
      const $=(s)=>document.querySelector(s);
      const player=$('#player'), video=$('#video'), srcEl=$('#src');
      const bigPlay=$('#bigPlay'), playBtn=$('#play'), iconPlay=$('#icon-play');
      const back10=$('#back10'), fwd10=$('#fwd10'), seek=$('#seek'), progressBar=$('#progressBar'), bufferedBar=$('#bufferedBar');
      const cur=$('#currentTime'), dur=$('#duration'), muteBtn=$('#mute'), vol=$('#volume'), speed=$('#speed'), fsBtn=$('#fs'), badgeDur=$('#badgeDur');
      const diag=$('#diag'), statusSrc=$('#statusSrc');
      const pillJA=$('#pillJA'), pillRO=$('#pillRO'), pillES=$('#pillES');

      function log(msg){ diag.innerHTML=`[${new Date().toLocaleTimeString()}] ${msg}<br>`+diag.innerHTML; }
      function setSrc(url){ srcEl.src=url; statusSrc.textContent='src: '+url; video.load(); }

      const fmt=(s)=>!isFinite(s)?'0:00':(s>=3600?Math.floor(s/3600)+':'+String(Math.floor(s%3600/60)).padStart(2,'0'):Math.floor(s/60)) + ':' + String(Math.floor(s%60)).padStart(2,'0');
      video.addEventListener('loadedmetadata',()=>{ dur.textContent=fmt(video.duration); badgeDur.textContent=fmt(video.duration); updateBuffered(); });
      video.addEventListener('error',()=>{ const code=video.error?video.error.code:'?'; log('ERROR VIDEO code='+code); });

      const togglePlay=()=> (video.paused||video.ended)?video.play():video.pause();
      [playBtn, video, bigPlay].forEach(el=>el.addEventListener('click', togglePlay));
      video.addEventListener('play', ()=>{ iconPlay.textContent='‚è∏'; bigPlay.style.display='none'; });
      video.addEventListener('pause', ()=>{ iconPlay.textContent='‚ñ∂';  bigPlay.style.display='grid'; });
      back10.addEventListener('click', ()=> video.currentTime=Math.max(0,(video.currentTime||0)-10));
      fwd10 .addEventListener('click', ()=> video.currentTime=Math.min(video.duration||0,(video.currentTime||0)+10));
      const updateTime=()=>{ cur.textContent=fmt(video.currentTime); const p=(video.currentTime/(video.duration||1))*100; progressBar.style.width=p+'%'; seek.value=Math.round((video.currentTime/(video.duration||1))*1000)||0; };
      const updateBuffered=()=>{ try{ if(video.buffered && video.buffered.length){ const end=video.buffered.end(video.buffered.length-1); bufferedBar.style.width=((end/(video.duration||1))*100)+'%'; } }catch(e){} };
      video.addEventListener('timeupdate', updateTime); video.addEventListener('progress', updateBuffered); video.addEventListener('loadeddata', updateBuffered);
      seek.addEventListener('input', ()=>{ video.currentTime=(seek.value/1000)*(video.duration||0); updateTime(); });
      const updMute=()=>{ const l=video.muted||video.volume===0?0:video.volume; muteBtn.textContent=l===0?'üîá':(l<.5?'üîà':'üîä'); };
      vol.addEventListener('input', ()=>{ video.volume=Number(vol.value); if(video.volume>0) video.muted=false; updMute(); });
      muteBtn.addEventListener('click', ()=>{ video.muted=!video.muted; updMute(); });
      video.addEventListener('volumechange', updMute); updMute();
      speed.addEventListener('change', ()=>{ video.playbackRate=Number(speed.value); });
      function toggleFS(){ if(document.fullscreenElement) document.exitFullscreen(); else player.requestFullscreen().catch(()=>{}); }
      fsBtn.addEventListener('click', toggleFS);

      const capJA=$('#cap-ja'), capRO=$('#cap-romaji'), capES=$('#cap-es');
      const trkJA=$('#trk-ja'), trkRO=$('#trk-ro'), trkES=$('#trk-es');
      const togJA=$('#tog-ja'), togRO=$('#tog-romaji'), togES=$('#tog-es'), togFG=$('#tog-fg');
      const tracks={ ja:trkJA?.track||null, ro:trkRO?.track||null, es:trkES?.track||null };
      Object.values(tracks).forEach(t=>{ if(t){ try{ t.mode='hidden'; }catch(_){}});

      function armTrack(el,name,pill){
        if(!el){ pill.textContent=`${name.toUpperCase()}: ‚Äî`; return; }
        const t=el.track;
        function ok(){ pill.textContent=`${name.toUpperCase()}: ok (${t.cues?t.cues.length:0})`; renderCue(); }
        function err(){ pill.textContent=`${name.toUpperCase()}: error`; }
        if(el.readyState===2) ok(); else{ el.addEventListener('load',ok,{once:true}); el.addEventListener('error',err,{once:true}); }
      }
      armTrack(trkJA,'ja',pillJA); armTrack(trkRO,'ro',pillRO); armTrack(trkES,'es',pillES);

      const state={ showJA:true, showRO:false, showES:false, showFG:false };
      const setPressed=(b,on)=>b.setAttribute('aria-pressed',on);
      const syncPress=()=>{ setPressed(togJA,state.showJA); setPressed(togRO,state.showRO); setPressed(togES,state.showES); setPressed(togFG,state.showFG); };
      syncPress();
      togJA.addEventListener('click',()=>{ state.showJA=!state.showJA; syncPress(); renderCue(); });
      togRO.addEventListener('click',()=>{ state.showRO=!state.showRO; syncPress(); renderCue(); });
      togES.addEventListener('click',()=>{ state.showES=!state.showES; syncPress(); renderCue(); });
      togFG.addEventListener('click',()=>{ state.showFG=!state.showFG; syncPress(); renderCue(); });

      /* ========= Diccionario extendido + part√≠culas ========= */
      const JA_DICT={
        "Â≠´ÊÇüÈ£Ø":{yomi:"„Åù„Çì„Åî„ÅØ„Çì",gloss:"Son Gohan",pos:"nombre propio"},
        "Ê≠£„Åó„ÅÑ":{yomi:"„Åü„Å†„Åó„ÅÑ",gloss:"correcto; justo",pos:"adj-i"},
        "Ê≠£„Åó„ÅÑ„Åì„Å®„ÅÆ„Åü„ÇÅ„Å´":{yomi:"„Åü„Å†„Åó„ÅÑ „Åì„Å® „ÅÆ „Åü„ÇÅ„Å´",gloss:"por lo correcto",pos:"expresi√≥n"},
        "„Åü„ÇÅ„Å´":{yomi:"„Åü„ÇÅ„Å´",gloss:"para; por el bien de",pos:"expresi√≥n"},
        "„Åì„Å®":{yomi:"„Åì„Å®",gloss:"cosa; hecho",pos:"sust./nominalizador"},
        "„Åì„Å®„ÅØ":{yomi:"„Åì„Å® „ÅØ",gloss:"en cuanto a la cosa",pos:"construcci√≥n"},
        "„Åì„Å®„ÅØ„Å™„ÅÑ":{yomi:"„Åì„Å® „ÅØ „Å™„ÅÑ",gloss:"no hace falta; no es necesario",pos:"expresi√≥n"},
        "Êà¶„ÅÜ":{yomi:"„Åü„Åü„Åã„ÅÜ",gloss:"pelear; luchar",pos:"verbo"},
        "Êà¶„ÅÜ„Åì„Å®":{yomi:"„Åü„Åü„Åã„ÅÜ „Åì„Å®",gloss:"pelear (nominalizado)",pos:"construcci√≥n"},
        "Êà¶„ÅÜ„Åì„Å®„ÅØ":{yomi:"„Åü„Åü„Åã„ÅÜ „Åì„Å® „ÅØ",gloss:"en cuanto a pelear",pos:"construcci√≥n"},
        "ÁΩ™":{yomi:"„Å§„Åø",gloss:"pecado; culpa",pos:"sust."},
        "ÁΩ™„Åß„ÅØ„Å™„ÅÑ":{yomi:"„Å§„Åø „Åß„ÅØ „Å™„ÅÑ",gloss:"no es un pecado",pos:"expresi√≥n"},
        "„Åß„ÅØ„Å™„ÅÑ":{yomi:"„Åß„ÅØ „Å™„ÅÑ",gloss:"no es (neg. de „Å†)",pos:"c√≥pula (neg.)"},
        "Ë©±„ÅóÂêà„ÅÑ":{yomi:"„ÅØ„Å™„Åó„ÅÇ„ÅÑ",gloss:"di√°logo; discusi√≥n",pos:"sust."},
        "Ë©±„ÅóÂêà„ÅÑ„Å™„Å©":{yomi:"„ÅØ„Å™„Åó„ÅÇ„ÅÑ „Å™„Å©",gloss:"di√°logo y similares",pos:"expresi√≥n"},
        "ÈÄöÁî®„Åó„Å™„ÅÑ":{yomi:"„Å§„ÅÜ„Çà„ÅÜ „Åó„Å™„ÅÑ",gloss:"no funciona; no surte efecto",pos:"verbo (neg.)"},
        "Áõ∏Êâã":{yomi:"„ÅÇ„ÅÑ„Å¶",gloss:"oponente; interlocutor",pos:"sust."},
        "Áõ∏Êâã„ÇÇ„ÅÑ„Çã„ÅÆ„Å†":{yomi:"„ÅÇ„ÅÑ„Å¶ „ÇÇ „ÅÑ„Çã „ÅÆ„Å†",gloss:"tambi√©n hay oponentes as√≠ (explicativo)",pos:"construcci√≥n"},
        "„ÇÇ„ÅÑ„Çã„ÅÆ„Å†":{yomi:"„ÇÇ „ÅÑ„Çã „ÅÆ„Å†",gloss:"tambi√©n hay/existen (explicativo)",pos:"construcci√≥n"},
        "„ÅÑ„Çã„ÅÆ„Å†":{yomi:"„ÅÑ„Çã „ÅÆ„Å†",gloss:"(estar/ser) explicativo",pos:"construcci√≥n"},
        "Á≤æÁ•û":{yomi:"„Åõ„ÅÑ„Åó„Çì",gloss:"esp√≠ritu; mente",pos:"sust."},
        "ÂÖâ„ÅÆ„Åæ„Åæ":{yomi:"„Å≤„Åã„Çä „ÅÆ „Åæ„Åæ",gloss:"manteniendo la luz",pos:"construcci√≥n"},
        "„ÅÆ„Åæ„Åæ":{yomi:"„ÅÆ „Åæ„Åæ",gloss:"tal como ~",pos:"construcci√≥n"},
        "Ëá™Áî±„Å´":{yomi:"„Åò„ÇÜ„ÅÜ„Å´",gloss:"libremente",pos:"adv."},
        "Ëß£Êîæ„Åó„Å¶":{yomi:"„Åã„ÅÑ„Åª„ÅÜ „Åó„Å¶",gloss:"liber√° / deja libre",pos:"verbo"},
        "„ÇÑ„Çå":{yomi:"„ÇÑ„Çå",gloss:"¬°hacelo! (imperativo)",pos:"verbo"},
        "Ëß£Êîæ„Åó„Å¶„ÇÑ„Çå":{yomi:"„Åã„ÅÑ„Åª„ÅÜ „Åó„Å¶ „ÇÑ„Çå",gloss:"liberalo (dar beneficio)",pos:"expresi√≥n"},
        "Ê∞óÊåÅ„Å°„ÅØ":{yomi:"„Åç„ÇÇ„Å° „ÅØ",gloss:"en cuanto al sentimiento",pos:"construcci√≥n"},
        "ÂàÜ„Åã„Çã":{yomi:"„Çè„Åã„Çã",gloss:"entender",pos:"verbo"},
        "ÂàÜ„Åã„Çã„ÅÆ„Åå":{yomi:"„Çè„Åã„Çã „ÅÆ „Åå",gloss:"el hecho de entender (sujeto)",pos:"construcci√≥n"},
        "„ÇÇ„ÅÜ":{yomi:"„ÇÇ„ÅÜ",gloss:"ya; m√°s",pos:"adv."},
        "ÊàëÊÖ¢„Åô„Çã":{yomi:"„Åå„Åæ„Çì „Åô„Çã",gloss:"aguantarse; soportar",pos:"verbo compuesto"},

        /* Part√≠culas (tipos) */
        "„ÅØ":{yomi:"„ÅØ",gloss:"marcador de tema/contraste",pos:"part√≠cula (tema)"},
        "„Åå":{yomi:"„Åå",gloss:"marcador de sujeto/√©nfasis",pos:"part√≠cula (sujeto)"},
        "„Çí":{yomi:"„Çí",gloss:"objeto directo",pos:"part√≠cula (objeto)"},
        "„Å´":{yomi:"„Å´",gloss:"tiempo/destino/receptor",pos:"part√≠cula (tiempo/lugar/destino)"},
        "„Åß":{yomi:"„Åß",gloss:"lugar de la acci√≥n; medio",pos:"part√≠cula (lugar/medio)"},
        "„Å∏":{yomi:"„Å∏",gloss:"direcci√≥n (hacia)",pos:"part√≠cula (direcci√≥n)"},
        "„Å®":{yomi:"„Å®",gloss:"'y'/con; cita",pos:"part√≠cula (conj./cita)"},
        "„ÇÇ":{yomi:"„ÇÇ",gloss:"tambi√©n; incluso",pos:"part√≠cula (aditiva)"},
        "„ÅÆ":{yomi:"„ÅÆ",gloss:"posesivo/nominalizador",pos:"part√≠cula (posesiva/nom.)"},
        "„ÅÆ„Å†":{yomi:"„ÅÆ„Å†",gloss:"estructura explicativa",pos:"construcci√≥n"}
      };
      const DICT_KEYS=Object.keys(JA_DICT).sort((a,b)=>b.length-a.length);

      /* Segmentaci√≥n: dict (longest-match) + Intl.Segmenter si est√° */
      const segJA=(typeof Intl!=='undefined' && Intl.Segmenter)? new Intl.Segmenter('ja',{granularity:'word'}) : null;
      function sliceWithDict(line){
        const parts=[]; let i=0;
        while(i<line.length){
          let matched=null; for(const k of DICT_KEYS){ if(line.startsWith(k,i)){ matched=k; break; } }
        if(matched){ const e=JA_DICT[matched]; parts.push({text:matched,start:i,end:i+matched.length,dict:e}); i+=matched.length; }
          else { parts.push({text:line[i],start:i,end=i+1,dict:null}); i++; }
        }
        return parts;
      }
      function tokenizeJA(line){
        const raw=sliceWithDict(line);
        if(!segJA) return raw;
        const out=[]; let buffer='', bStart=null;
        const flush=()=>{ if(!buffer) return; let pos=0; for(const it of segJA.segment(buffer)){ const seg=it.segment; const st=bStart + buffer.indexOf(seg,pos); const en=st+seg.length; pos=bStart + buffer.indexOf(seg,pos) - bStart + seg.length; out.push({text:seg,start:st,end:en,dict:null}); } buffer=''; bStart=null; };
        for(const p of raw){ if(p.dict){ flush(); out.push(p); } else { if(!buffer){ buffer=p.text; bStart=p.start; } else buffer+=p.text; } }
        flush(); return out;
      }

      /* Romaji helpers */
      const ROMA_MAP={ '„Åç„ÇÉ':'kya','„Åç„ÇÖ':'kyu','„Åç„Çá':'kyo','„Åó„ÇÉ':'sha','„Åó„ÇÖ':'shu','„Åó„Çá':'sho','„Å°„ÇÉ':'cha','„Å°„ÇÖ':'chu','„Å°„Çá':'cho','„Å´„ÇÉ':'nya','„Å´„ÇÖ':'nyu','„Å´„Çá':'nyo','„Å≤„ÇÉ':'hya','„Å≤„ÇÖ':'hyu','„Å≤„Çá':'hyo','„Åø„ÇÉ':'mya','„Åø„ÇÖ':'myu','„Åø„Çá':'myo','„Çä„ÇÉ':'rya','„Çä„ÇÖ':'ryu','„Çä„Çá':'ryo','„Åé„ÇÉ':'gya','„Åé„ÇÖ':'gyu','„Åé„Çá':'gyo','„Åò„ÇÉ':'ja','„Åò„ÇÖ':'ju','„Åò„Çá':'jo','„Å≥„ÇÉ':'bya','„Å≥„ÇÖ':'byu','„Å≥„Çá':'byo','„Å¥„ÇÉ':'pya','„Å¥„ÇÖ':'pyu','„Å¥„Çá':'pyo',
        '„ÅÇ':'a','„ÅÑ':'i','„ÅÜ':'u','„Åà':'e','„Åä':'o','„Åã':'ka','„Åç':'ki','„Åè':'ku','„Åë':'ke','„Åì':'ko','„Åï':'sa','„Åó':'shi','„Åô':'su','„Åõ':'se','„Åù':'so','„Åü':'ta','„Å°':'chi','„Å§':'tsu','„Å¶':'te','„Å®':'to','„Å™':'na','„Å´':'ni','„Å¨':'nu','„Å≠':'ne','„ÅÆ':'no','„ÅØ':'ha','„Å≤':'hi','„Åµ':'fu','„Å∏':'he','„Åª':'ho','„Åæ':'ma','„Åø':'mi','„ÇÄ':'mu','„ÇÅ':'me','„ÇÇ':'mo','„ÇÑ':'ya','„ÇÜ':'yu','„Çà':'yo','„Çâ':'ra','„Çä':'ri','„Çã':'ru','„Çå':'re','„Çç':'ro','„Çè':'wa','„Çí':'o','„Çì':'n','„Åå':'ga','„Åé':'gi','„Åê':'gu','„Åí':'ge','„Åî':'go','„Åñ':'za','„Åò':'ji','„Åö':'zu','„Åú':'ze','„Åû':'zo','„Å†':'da','„Å¢':'ji','„Å•':'zu','„Åß':'de','„Å©':'do','„Å∞':'ba','„Å≥':'bi','„Å∂':'bu','„Åπ':'be','„Åº':'bo','„Å±':'pa','„Å¥':'pi','„Å∑':'pu','„Å∫':'pe','„ÅΩ':'po','„ÅÅ':'a','„ÅÉ':'i','„ÅÖ':'u','„Åá':'e','„Åâ':'o','„ÇÉ':'ya','„ÇÖ':'yu','„Çá':'yo','„Å£':'','„Éº':'' };
      function hiraToRoma(str){ let out=''; for(let i=0;i<str.length;i++){ const ch=str[i], next=str[i+1]||''; if(ch==='„Å£' && next){ const roma=ROMA_MAP[next]||''; if(roma) out+=roma[0]; continue; } const dig=str.slice(i,i+2); if(ROMA_MAP[dig]){ out+=ROMA_MAP[dig]; i++; continue; } out+=ROMA_MAP[ch]||ch; } return out; }
      function yomiToRoma(surface,yomi,pos){ let r=yomi||''; if(!r && /[\u3040-\u309f]/.test(surface)) r=surface; let rom=r?hiraToRoma(r):''; if(surface==='„ÅØ' && pos && pos.includes('part√≠cula')) rom='wa'; if(surface==='„Å∏' && pos && pos.includes('part√≠cula')) rom='e'; if(surface==='„Çí') rom='o'; return rom; }

      /* Normalizaci√≥n para comparar con RO (maneja macrones) */
      const stripDiacritics = s => {
        const n = (s.normalize? s.normalize('NFD') : s);
        return n.replace(/\p{Diacritic}/gu,'').replace(/[\u0300-\u036f]/g,'');
      };
      const norm = s => stripDiacritics((s||'').toLowerCase()).replace(/[^a-z0-9]/g,'');
      const squeezeLong = s => s.replace(/ou/g,'o').replace(/oo/g,'o').replace(/uu/g,'u');

      /* ============== Render ============== */
      function renderLine(track, el, mode){
        const show=(state.showJA&&mode==='ja')||(state.showRO&&mode==='ro')||(state.showES&&mode==='es');
        if(!show){ el.hidden=true; el.innerHTML=''; return; }
        let cue=null;
        if(track?.activeCues?.length) cue=track.activeCues[0];
        else if(track?.cues?.length){ const t=video.currentTime; for(let i=0;i<track.cues.length;i++){ const c=track.cues[i]; if(t>=c.startTime && t<=c.endTime){ cue=c; break; } } }
        if(!cue){ el.hidden=true; el.innerHTML=''; return; }

        el.hidden=false; el.innerHTML='';
        const lines=cue.text.split(/\r?\n/);
        for(let li=0; li<lines.length; li++){
          const lineText=lines[li];
          if(mode==='ja'){
            const tokens=tokenizeJA(lineText);
            const lineWrap=document.createElement('span'); lineWrap.className='line-ja'; lineWrap.dataset.text=lineText; lineWrap.dataset.li=li;
            tokens.forEach((tok,idx)=>{
              const sp=document.createElement('span'); sp.className='word-ja'; sp.dataset.word=tok.text.trim(); sp.dataset.start=tok.start; sp.dataset.end=tok.end; sp.dataset.idx=idx; sp.dataset.li=li;
              if(tok.dict && state.showFG){ sp.innerHTML=`<ruby><rb>${tok.text}</rb><rt>${tok.dict.yomi}</rt></ruby>`; } else { sp.textContent=tok.text; }
              if(tok.dict){ sp.dataset.yomi=tok.dict.yomi; sp.dataset.gloss=tok.dict.gloss; sp.dataset.pos=tok.dict.pos||''; sp.dataset.dict='1'; } else { sp.dataset.dict='0'; }
              lineWrap.appendChild(sp);
            });
            el.appendChild(lineWrap);
          } else if(mode==='ro'){
            const lineWrap=document.createElement('span'); lineWrap.className='line-ro'; lineWrap.dataset.li=li;
            let normStr=''; let idx=0;
            const parts=lineText.split(/(\s+|[.,!?¬°¬ø‚Ä¶:;()\[\]"'\-])/).filter(Boolean);
            parts.forEach(tok=>{
              if(/\s+|[.,!?¬°¬ø‚Ä¶:;()\[\]"'\-]/.test(tok)){ lineWrap.appendChild(document.createTextNode(tok)); }
              else {
                const sp=document.createElement('span'); sp.className='word-ro'; sp.textContent=tok;
                const n=norm(tok); sp.dataset.ns=idx; sp.dataset.ne=idx+n.length; idx+=n.length; normStr+=n; lineWrap.appendChild(sp);
              }
            });
            lineWrap.dataset.norm=normStr; lineWrap.dataset.normSq=squeezeLong(normStr);
            el.appendChild(lineWrap);
          } else {
            el.appendChild(document.createTextNode(lineText));
          }
          if(li<lines.length-1) el.appendChild(document.createElement('br'));
        }
      }

      function renderCue(){ renderLine(tracks.ja,capJA,'ja'); renderLine(tracks.ro,capRO,'ro'); renderLine(tracks.es,capES,'es'); }
      Object.values(tracks).forEach(t=>{ t && t.addEventListener('cuechange', renderCue); });
      ["timeupdate","seeked","ratechange"].forEach(ev=>video.addEventListener(ev, renderCue));
      window.addEventListener('load', renderCue);

      /* ===== Hover JA ‚Üí resaltar RO + Popover ===== */
      const pop=$('#popover'), pvWord=$('#pv-word'), pvReading=$('#pv-reading'), pvMeaning=$('#pv-meaning');

      function clearROHL(){ capRO.querySelectorAll('.hl').forEach(el=>el.classList.remove('hl')); }
      function highlightInRO(romaji, li){
        clearROHL(); if(!state.showRO || !romaji) return;
        const roLine = capRO.querySelector(`.line-ro[data-li="${li}"]`) || capRO.querySelector('.line-ro'); if(!roLine) return;
        const targetN = norm(romaji); const targetS = squeezeLong(targetN);
        const hayN = roLine.dataset.norm||''; const hayS = roLine.dataset.normSq||'';
        let idx = hayN.indexOf(targetN); let useSq=false;
        if(idx<0){ idx = hayS.indexOf(targetS); useSq=true; }
        if(idx>=0){
          const end = idx + (useSq? targetS.length : targetN.length);
          roLine.querySelectorAll('.word-ro').forEach(sp=>{
            const ns=+sp.dataset.ns, ne=+sp.dataset.ne;
            if(ns<end && ne>idx) sp.classList.add('hl');
          });
        }
      }

      document.addEventListener('mousemove',(e)=>{
        if(!state.showJA) return;
        const sp=e.target.closest('.word-ja');
        if(!sp || !capJA.contains(sp)) { clearROHL(); return; }
        const li = Number(sp.dataset.li||0);
        const rom = yomiToRoma(sp.dataset.word||'', sp.dataset.yomi||'', sp.dataset.pos||'');
        if(rom) highlightInRO(rom, li); else clearROHL();
      });
      document.addEventListener('mouseleave', ()=> clearROHL(), true);

      function longestDictAt(line,pos){
        let best=null;
        for(const k of DICT_KEYS){
          const i=line.indexOf(k);
          if(i!==-1 && i<=pos && pos<i+k.length){
            if(!best || k.length>best.text.length) best={text:k,start:i,end:i+k.length,entry:JA_DICT[k]};
          }
        }
        return best;
      }

      document.addEventListener('click',(e)=>{
        if(!state.showJA) return;
        if(!capJA.contains(e.target)) { if(!e.target.closest('#popover')) pop.style.display='none'; return; }
        const span=e.target.closest('.word-ja'); if(!span) return;

        const lineWrap=span.closest('.line-ja');
        const lineText=lineWrap?lineWrap.dataset.text||'':span.textContent;
        const start=Number(span.dataset.start)||0;
        const end=Number(span.dataset.end)||start+(span.textContent||'').length;
        const pos=Math.floor((start+end)/2);

        let surface=span.dataset.word||span.textContent;
        let entry=(span.dataset.dict==='1')?{yomi:span.dataset.yomi,gloss:span.dataset.gloss,pos:span.dataset.pos}:null;
        if(!entry){ const best=longestDictAt(lineText, pos); if(best){ surface=best.text; entry={yomi:best.entry.yomi,gloss:best.entry.gloss,pos:best.entry.pos||''}; } }

        pvWord.textContent=surface;
        pvReading.textContent = entry? `Lectura: ${entry.yomi}` : 'Lectura: ‚Äî';
        pvMeaning.textContent = entry? `Significado: ${entry.gloss}` : 'Significado: part√≠cula/conector o sin entrada';

        const rect=player.getBoundingClientRect();
        pop.style.display='block';
        pop.style.left=(Math.min(rect.width-10, Math.max(10, e.clientX - rect.left + 8)))+'px';
        pop.style.top =(Math.min(rect.height-10, Math.max(10, e.clientY - rect.top + 8)) - 10)+'px';
      }, true);

      // Herramientas
      $('#btnTest').addEventListener('click', ()=>{ setSrc('https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'); log('Cargando video de prueba MDN'); });
      $('#btnURL').addEventListener('click', ()=>{ const u=prompt('Peg√° una URL directa a .mp4 (https://...)'); if(!u) return; setSrc(u.trim()); log('Cambi√© src a '+u); });

      // Atajos
      document.addEventListener('keydown',(e)=>{ if(e.key==='j'||e.key==='J'){togJA.click()} if(e.key==='a'||e.key==='A'){togRO.click()} if(e.key==='e'||e.key==='E'){togES.click()} if(e.key==='g'||e.key==='G'){togFG.click()} });
    })();
  </script>

  <script>
  /* Diagn√≥stico de codec + fallback a clip MDN si tu MP4 no es H.264/AAC */
  (function(){
    var diag=document.getElementById('diag');
    function log(m){ diag.innerHTML='['+new Date().toLocaleTimeString()+'] '+m+'<br>'+diag.innerHTML; }
    var video=document.getElementById('video'); var srcEl=document.getElementById('src');
    function probe(){ try{ var res=[
      'H.264 Baseline + AAC: '+(video.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')||'no'),
      'H.264 Main + AAC: '+(video.canPlayType('video/mp4; codecs="avc1.4D401E, mp4a.40.2"')||'no'),
      'H.264 High + AAC: '+(video.canPlayType('video/mp4; codecs="avc1.64001F, mp4a.40.2"')||'no')
    ].join(' ¬∑ '); log('canPlayType ‚Üí '+res);}catch(e){}
    try{ fetch(srcEl.src,{method:'HEAD'}).then(r=>{ log('HEAD '+srcEl.src+' ‚Üí '+r.status+' '+(r.ok?'OK':'')+' Content-Type='+(r.headers.get('content-type')||'-')+' Length='+(r.headers.get('content-length')||'-')); }).catch(e=>log('HEAD error: '+e)); }catch(e){}
    }
    window.addEventListener('load', probe);
    video.addEventListener('error', function(){
      var code=video.error?video.error.code:0;
      var map={1:'ABORTED',2:'NETWORK',3:'DECODE',4:'SRC_NOT_SUPPORTED'};
      log('ERROR VIDEO code='+code+' ('+(map[code]||'?')+')'); probe();
      if(code===3||code===4){
        srcEl.src='https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4';
        document.getElementById('statusSrc').textContent='src: '+srcEl.src;
        video.load();
        setTimeout(probe,0);
      }
    });
  })();
  </script>
</body>
</html>


