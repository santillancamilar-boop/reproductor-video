<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reproductor DBZ ‚Äî Pages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#f6f7fb; --ink:#2d2a32; --muted:#6b6a73; --panel:#ffffff; --edge:#e9e8f2; --accent:#b59bff; }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--ink);
      background:
        radial-gradient(1000px 1000px at 10% -10%, #efeaff 0%, transparent 55%),
        radial-gradient(900px 900px at 100% 0%, #e3fff7 0%, transparent 55%),
        linear-gradient(180deg,var(--bg),#fdfcff 60%);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .player{ background:var(--panel); border:1px solid var(--edge); border-radius:22px; box-shadow:0 10px 30px rgba(23,15,41,.08); max-width:960px; width:100% }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px;
      background:linear-gradient(135deg, color-mix(in oklch,var(--accent), white 20%), color-mix(in oklch,var(--accent), black 8%)); color:#2b223d }
    .title{ margin:0; font-size:16px; font-weight:700; letter-spacing:.3px }
    .badge{ font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.65); border:1px solid rgba(0,0,0,.05) }

    .stage{ position:relative; background:#000 }
    video{ width:100%; height:auto; display:block; background:#000; position:relative; z-index:1 }
    .center-play{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none }
    .center-play .btn-big{ pointer-events:auto; --size:72px; width:var(--size); height:var(--size); border-radius:999px; border:none; display:grid; place-items:center; font-size:28px; color:white; background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.45)); box-shadow:0 10px 30px rgba(0,0,0,.2) }

    .controls{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:14px 16px; padding:14px 16px 12px }
    .row{ display:flex; align-items:center; gap:8px }
    .btn{ --size:40px; width:var(--size); height:var(--size); display:grid; place-items:center; border-radius:12px; border:1px solid var(--edge); background:linear-gradient(180deg,#fff,#fafafe); box-shadow:0 6px 16px rgba(23,15,41,.08); cursor:pointer; color:var(--ink) }
    .btn[aria-pressed="true"]{ outline:2px solid color-mix(in oklch,var(--accent),white 15%) }

    .seek{ grid-column:1/-1; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px }
    .time{ font-variant-numeric:tabular-nums; color:var(--muted); font-size:14px; min-width:70px; text-align:center }
    .range{ position:relative; height:22px; display:grid; align-items:center }
    .buffered,.progress{ pointer-events:none; position:absolute; left:0; height:4px; border-radius:999px }
    .buffered{ width:0%; background:#e8e7f4 } .progress{ width:0%; background:var(--accent) }
    input[type="range"].slider{-webkit-appearance:none; appearance:none; width:100%; height:4px; background:transparent; outline:none}
    input[type="range"].slider::-webkit-slider-thumb{-webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:white; border:2px solid var(--accent); box-shadow:0 2px 6px rgba(0,0,0,.12); margin-top:-6px}
    .vol{width:min(180px,25vw)}
    input[type="range"].vol-slider{-webkit-appearance:none; appearance:none; width:100%; height:4px; background:#efeef8; border-radius:999px}
    input[type="range"].vol-slider::-webkit-slider-thumb{ width:14px; height:14px; border-radius:50%; background:var(--accent) }

    .select{ padding:8px 10px; border-radius:12px; border:1px solid var(--edge); background:linear-gradient(180deg,#fff,#fafafe); color:var(--ink) }
    .foot{ color:var(--muted); font-size:13px; padding:0 16px 16px }

    /* Subt√≠tulos overlay */
    .captions{ position:absolute; left:0; right:0; bottom:6%; display:flex; flex-direction:column; gap:6px; align-items:center; padding:0 12px; z-index:5; pointer-events:auto }
    .cap-line{ max-width:min(86%, 900px); width:fit-content; color:#111; font-weight:600; letter-spacing:.2px; line-height:1.35; border-radius:14px; padding:8px 12px; box-shadow:0 6px 20px rgba(0,0,0,.16) }
    .track-ja{ background:rgba(255,255,255,.92) }
    .track-romaji{ background:rgba(255,245,232,.95) }
    .track-es{ background:rgba(236,253,245,.95) }

    .word-ja{ cursor:pointer; padding:0 2px; border-radius:6px }
    .word-ja:hover{ background:rgba(0,0,0,.06) }
    .track-romaji .word-ro{ pointer-events:none; cursor:default; padding:0 2px; border-radius:6px }

    /* highlight sincronizado */
    .hl { outline:2px solid color-mix(in oklch,var(--accent),white 15%); background:rgba(181,155,255,.12); border-radius:6px }

    /* Popover (solo JA) */
    .popover{ position:absolute; z-index:10; min-width:220px; max-width:320px; background:#fff; border:1px solid var(--edge); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.15); padding:10px 12px; display:none }
    .popover .word{ font-weight:800 } .popover .hint{ color:var(--muted); font-size:12px }
    .popover .meaning{ margin-top:6px }

    /* Badges peque√±os (romaji sugerido) */
    .ro-badge{ margin-left:8px; font-size:12px; padding:2px 6px; border-radius:999px; border:1px solid var(--edge); background:#fff }

    /* Diagn√≥stico oculto */
    .diag{ display:none; }
    .pill{ padding:4px 8px; border-radius:999px; border:1px solid var(--edge); background:#f7f7ff; white-space:nowrap }
    .tools{ display:flex; gap:8px; padding:0 16px 16px; flex-wrap:wrap }
    .tools .btn{ height:auto; padding:8px 12px; width:auto }

    ruby{ ruby-position:over; } rt{ font-size:.65em; color:#6b6a73 }
  </style>
</head>
<body>
  <div class="player" id="player" tabindex="0" aria-label="Reproductor de video con subt√≠tulos y panel flotante">
    <div class="header">
      <h1 class="title">Proyecto integral ‚Äî Reproductor</h1>
      <span class="badge" id="badgeDur">00:00</span>
    </div>

    <div class="stage">
      <video id="video" preload="metadata" playsinline webkit-playsinline poster="poster.jpg">
        <source id="src" src="video.mp4" type="video/mp4" />
        <!-- Pistas (mismo origen) -->
        <track id="trk-ja" label="Êó•Êú¨Ë™û"   kind="subtitles" srclang="ja"      src="subs-ja.vtt" default />
        <track id="trk-ro" label="R≈çmaji"  kind="subtitles" srclang="ja-Latn" src="subs-ro.vtt" />
        <track id="trk-es" label="Espa√±ol" kind="subtitles" srclang="es"      src="subs-es.vtt" />
        Tu navegador no soporta la etiqueta <code>video</code>.
      </video>

      <div class="center-play"><button class="btn-big" id="bigPlay" title="Reproducir">‚ñ∂</button></div>

      <div class="captions" id="captions">
        <div class="cap-line track-ja"     id="cap-ja" hidden></div>
        <div class="cap-line track-romaji" id="cap-romaji" hidden></div>
        <div class="cap-line track-es"     id="cap-es" hidden></div>
      </div>

      <div class="popover" id="popover">
        <div><span class="word" id="pv-word">‚Äî</span></div>
        <div class="hint" id="pv-read">Lectura: ‚Äî</div>
        <div class="meaning" id="pv-meaning">Significado: ‚Äî</div>
      </div>
    </div>

    <div class="controls" role="group" aria-label="Controles">
      <div class="row">
        <button class="btn" id="back10" title="Retroceder 10s">‚ü≤</button>
        <button class="btn" id="play"   title="Reproducir/Pausar"><span id="icon-play">‚ñ∂</span></button>
        <button class="btn" id="fwd10"  title="Avanzar 10s">‚ü≥</button>
      </div>
      <div class="row seek" aria-label="Barra de progreso">
        <div class="time" id="currentTime">0:00</div>
        <div class="range">
          <div class="buffered" id="bufferedBar"></div>
          <div class="progress" id="progressBar"></div>
          <input id="seek" class="slider" type="range" min="0" max="1000" step="1" value="0" />
        </div>
        <div class="time" id="duration">0:00</div>
      </div>
      <div class="row">
        <button class="btn" id="mute" title="Silenciar/Activar">üîä</button>
        <div class="vol"><input id="volume" class="vol-slider" type="range" min="0" max="1" step="0.01" value="1" /></div>
      </div>
      <div class="row">
        <select id="speed" class="select" aria-label="Velocidad">
          <option value="0.5">0.5√ó</option>
          <option value="0.75">0.75√ó</option>
          <option value="1" selected>1√ó</option>
          <option value="1.25">1.25√ó</option>
          <option value="1.5">1.5√ó</option>
          <option value="1.75">1.75√ó</option>
          <option value="2">2√ó</option>
        </select>
        <!-- Independientes: pod√©s combinar JA/RO/ES + Furigana -->
        <button class="btn" id="tog-ja"      aria-pressed="true"  title="Alternar Japon√©s">JA</button>
        <button class="btn" id="tog-romaji"  aria-pressed="false" title="Alternar R≈çmaji">RO</button>
        <button class="btn" id="tog-es"      aria-pressed="false" title="Alternar Espa√±ol">ES</button>
        <button class="btn" id="tog-fg"      aria-pressed="false" title="Furigana en JA">FG</button>
        <button class="btn" id="fs"          title="Pantalla completa">‚§¢</button>
      </div>
    </div>

    <div class="tools">
      <button class="btn" id="btnTest">Probar video de prueba (MDN)</button>
      <button class="btn" id="btnURL">Cargar por URL‚Ä¶</button>
      <span class="pill" id="statusSrc">src: video.mp4</span>
      <span class="pill" id="pillJA">JA: ‚Äî</span>
      <span class="pill" id="pillRO">RO: ‚Äî</span>
      <span class="pill" id="pillES">ES: ‚Äî</span>
    </div>
    <div class="diag" id="diag"></div>

    <div class="foot">Atajos: Espacio ¬∑ ‚Üê/‚Üí ¬±5s ¬∑ ‚Üë/‚Üì volumen ¬∑ M mute ¬∑ F pantalla completa ¬∑ J/A/E alternar JA/RO/ES ¬∑ G furigana</div>
  </div>


<script>
(function(){
  // ===== util =====
  function $(s){ return document.querySelector(s); }
  function log(msg){
    var diag = $('#diag'); if(!diag) return;
    diag.innerHTML = '['+(new Date().toLocaleTimeString())+'] '+msg+'<br>'+diag.innerHTML;
  }
  function norm(s){
    if(!s) return '';
    var mac = {'ƒÄ':'aa','ƒÅ':'aa','ƒ™':'ii','ƒ´':'ii','≈™':'uu','≈´':'uu','ƒí':'ee','ƒì':'ee','≈å':'ou','≈ç':'ou'};
    s = s.replace(/[ƒÄƒÅƒ™ƒ´≈™≈´ƒíƒì≈å≈ç]/g, function(ch){ return mac[ch]||ch; });
    try{ s = s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
    catch(_){ s = s.toLowerCase(); }
    return s.replace(/[^a-z0-9]/g,'');
  }
  // ===== refs UI =====
  var player=$('#player'), video=$('#video'), srcEl=$('#src');
  var bigPlay=$('#bigPlay'), playBtn=$('#play'), iconPlay=$('#icon-play');
  var back10=$('#back10'), fwd10=$('#fwd10'), seek=$('#seek'), progressBar=$('#progressBar'), bufferedBar=$('#bufferedBar');
  var cur=$('#currentTime'), dur=$('#duration'), muteBtn=$('#mute'), vol=$('#volume'), speed=$('#speed'), fs=$('#fs'), badgeDur=$('#badgeDur');
  var capJA=$('#cap-ja'), capRO=$('#cap-romaji'), capES=$('#cap-es');
  var trkJA=$('#trk-ja'), trkRO=$('#trk-ro'), trkES=$('#trk-es');
  var togJA=$('#tog-ja'), togRO=$('#tog-romaji'), togES=$('#tog-es'), togFG=$('#tog-fg');
  var pop=$('#popover'), pvWord=$('#pv-word'), pvRead=$('#pv-read'), pvMeaning=$('#pv-meaning');

  // sanity
  if(!player||!video||!capJA||!capRO){ log('Falta alg√∫n nodo clave (player/video/capJA/capRO)'); }

  // ===== video (sin tocar l√≥gica original) =====
  function setSrc(url){ if(srcEl){ srcEl.src=url; } var statusSrc=$('#statusSrc'); if(statusSrc) statusSrc.textContent='src: '+url; video.load(); }
  function formatTime(s){ if(!isFinite(s)) return '0:00'; var h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=(''+Math.floor(s%60)).padStart(2,'0'); return (h>0? h+':'+(''+m).padStart(2,'0'):m)+':'+sec; }
  video.addEventListener('loadedmetadata',function(){ if(dur) dur.textContent=formatTime(video.duration); if(badgeDur) badgeDur.textContent=formatTime(video.duration); updateBuffered(); log('loadedmetadata'); });
  function togglePlay(){ (video.paused||video.ended)?video.play():video.pause(); }
  if(playBtn) playBtn.addEventListener('click', togglePlay);
  if(bigPlay) bigPlay.addEventListener('click', togglePlay);
  video.addEventListener('click', togglePlay);
  video.addEventListener('play', function(){ if(iconPlay) iconPlay.textContent='‚è∏'; if(bigPlay) bigPlay.style.display='none'; });
  video.addEventListener('pause', function(){ if(iconPlay) iconPlay.textContent='‚ñ∂';  if(bigPlay) bigPlay.style.display='grid'; });
  if(back10) back10.addEventListener('click', function(){ video.currentTime=Math.max(0,(video.currentTime||0)-10); });
  if(fwd10)  fwd10 .addEventListener('click', function(){ video.currentTime=Math.min(video.duration||0,(video.currentTime||0)+10); });
  function updateTime(){ if(cur) cur.textContent=formatTime(video.currentTime); var pct=(video.currentTime/(video.duration||1))*100; if(progressBar) progressBar.style.width=pct+'%'; if(seek) seek.value = Math.round((video.currentTime/(video.duration||1))*1000)||0; }
  function updateBuffered(){ try{ if(video.buffered && video.buffered.length){ var end=video.buffered.end(video.buffered.length-1); if(bufferedBar) bufferedBar.style.width=((end/(video.duration||1))*100)+'%'; } }catch(e){} }
  video.addEventListener('timeupdate', updateTime);
  video.addEventListener('progress', updateBuffered);
  video.addEventListener('loadeddata', updateBuffered);
  if(seek) seek.addEventListener('input', function(){ video.currentTime=(seek.value/1000)*(video.duration||0); updateTime(); });
  if(vol)  vol .addEventListener('input', function(){ video.volume=Number(vol.value); if(video.volume>0) video.muted=false; updateMuteIcon(); });
  if(muteBtn) muteBtn.addEventListener('click', function(){ video.muted=!video.muted; updateMuteIcon(); });
  video.addEventListener('volumechange', updateMuteIcon); updateMuteIcon();
  function updateMuteIcon(){ var level=video.muted||video.volume===0?0:video.volume; if(muteBtn) muteBtn.textContent= level===0?'üîá':(level<.5?'üîà':'üîä'); }
  if(speed) speed.addEventListener('change', function(){ video.playbackRate=Number(speed.value); });
  if(fs) fs.addEventListener('click', function(){ if(document.fullscreenElement) document.exitFullscreen(); else player.requestFullscreen().catch(function(){}); });

  // ===== estado/toggles =====
  var state={ showJA:true, showRO:false, showES:false, showFG:false };
  function setToggle(btn,on){ if(btn) btn.setAttribute('aria-pressed', on); }
  function syncToggles(){ setToggle(togJA,state.showJA); setToggle(togRO,state.showRO); setToggle(togES,state.showES); setToggle(togFG,state.showFG); }
  syncToggles();
  if(togJA) togJA.addEventListener('click', function(){ state.showJA=!state.showJA; syncToggles(); renderCue(); });
  if(togRO) togRO.addEventListener('click', function(){ state.showRO=!state.showRO; syncToggles(); renderCue(); });
  if(togES) togES.addEventListener('click', function(){ state.showES=!state.showES; syncToggles(); renderCue(); });
  if(togFG) togFG.addEventListener('click', function(){ state.showFG=!state.showFG; syncToggles(); renderCue(); });

  // ===== diccionario (part√≠culas + extras + ro preferente) =====
  var JA_DICT={
    "Â≠´ÊÇüÈ£Ø":{yomi:"„Åù„Çì„Åî„ÅØ„Çì",gloss:"Son Gohan (nombre propio)", ro:"son gohan"},
    "Ê≠£„Åó„ÅÑ":{yomi:"„Åü„Å†„Åó„ÅÑ",gloss:"correcto; justo", ro:"tadashii"},
    "„Åì„Å®":{yomi:"„Åì„Å®",gloss:"cosa; hecho", ro:"koto"},
    "„Åü„ÇÅ„Å´":{yomi:"„Åü„ÇÅ„Å´",gloss:"para; por el bien de", ro:"tame ni"},
    "Êà¶„ÅÜ":{yomi:"„Åü„Åü„Åã„ÅÜ",gloss:"pelear; luchar", ro:"tatakau"},
    "ÁΩ™":{yomi:"„Å§„Åø",gloss:"pecado; culpa", ro:"tsumi"},
    "„Åß„ÅØ„Å™„ÅÑ":{yomi:"„Åß„ÅØ„Å™„ÅÑ",gloss:"no es; no ser", ro:"de wa nai"},
    "Ë©±„ÅóÂêà„ÅÑ":{yomi:"„ÅØ„Å™„Åó„ÅÇ„ÅÑ",gloss:"di√°logo; discusi√≥n", ro:"hanashiai"},
    "„Å™„Å©":{yomi:"„Å™„Å©",gloss:"etc.; cosas como ~", ro:"nado"},
    "ÈÄöÁî®„Åó„Å™„ÅÑ":{yomi:"„Å§„ÅÜ„Çà„ÅÜ„Åó„Å™„ÅÑ",gloss:"no funciona; no surte efecto", ro:"tsuuyou shinai"},
    "Áõ∏Êâã":{yomi:"„ÅÇ„ÅÑ„Å¶",gloss:"oponente; interlocutor", ro:"aite"},
    "„ÇÇ„ÅÑ„Çã„ÅÆ„Å†":{yomi:"„ÇÇ„ÅÑ„Çã„ÅÆ„Å†",gloss:"tambi√©n hay (explicativo)", ro:"mo iru no da"},
    "„ÅÑ„Çã„ÅÆ„Å†":{yomi:"„ÅÑ„Çã„ÅÆ„Å†",gloss:"(alguien) est√° (explicativo)", ro:"iru no da"},
    "Á≤æÁ•û":{yomi:"„Åõ„ÅÑ„Åó„Çì",gloss:"esp√≠ritu; mente", ro:"seishin"},
    "ÂÖâ":{yomi:"„Å≤„Åã„Çä",gloss:"luz", ro:"hikari"},
    "Ëá™Áî±„Å´":{yomi:"„Åò„ÇÜ„ÅÜ„Å´",gloss:"libremente", ro:"jiyuu ni"},
    "Ëß£Êîæ„Åó„Å¶„ÇÑ„Çå":{yomi:"„Åã„ÅÑ„Åª„ÅÜ„Åó„Å¶„ÇÑ„Çå",gloss:"lib√©ralo / d√©jalo libre", ro:"kaihou shite yare"},
    "Ê∞óÊåÅ„Å°":{yomi:"„Åç„ÇÇ„Å°",gloss:"sentimiento", ro:"kimochi"},
    "ÂàÜ„Åã„Çã":{yomi:"„Çè„Åã„Çã",gloss:"entender", ro:"wakaru"},
    "„ÇÇ„ÅÜ":{yomi:"„ÇÇ„ÅÜ",gloss:"ya / m√°s", ro:"mou"},
    "ÊàëÊÖ¢„Åô„Çã":{yomi:"„Åå„Åæ„Çì„Åô„Çã",gloss:"aguantarse / soportar", ro:"gaman suru"},
    "„Åì„Å®„ÅØ„Å™„ÅÑ":{yomi:"„Åì„Å®„ÅØ„Å™„ÅÑ",gloss:"no hace falta / no es necesario", ro:"koto wa nai"},
    "„ÅÆ„Åå":{yomi:"„ÅÆ„Åå",gloss:"‚Äòel hecho de‚Ä¶‚Äô (nominalizador + sujeto)", ro:"no ga", note:"Nominaliza y marca como sujeto."},

    // part√≠culas (incluye variantes de ro)
    "„Çí":{yomi:"„Çí",gloss:"marcador de objeto directo",pos:"part√≠cula (objeto)", ro:"o",  rov:["wo"], note:"Marca el objeto directo."},
    "„ÅØ":{yomi:"„ÅØ",gloss:"marcador de tema/contraste",pos:"part√≠cula (tema)", ro:"wa", rov:["ha"], note:"Presenta tema; contrasta con „Åå."},
    "„Åå":{yomi:"„Åå",gloss:"marcador de sujeto/√©nfasis",pos:"part√≠cula (sujeto)", ro:"ga", note:"Enfatiza sujeto o introduce info nueva."},
    "„ÇÇ":{yomi:"„ÇÇ",gloss:"tambi√©n; incluso",pos:"part√≠cula (aditiva)", ro:"mo", note:"X„ÇÇ = ‚Äòtambi√©n X‚Äô."},
    "„ÅÆ":{yomi:"„ÅÆ",gloss:"posesivo; nominalizador",pos:"part√≠cula", ro:"no", note:"Une sustantivos (‚Äòde‚Äô) o nominaliza."},
    "„Å´":{yomi:"„Å´",gloss:"tiempo/lugar destino/receptor",pos:"part√≠cula", ro:"ni", note:"Tiempo, destino, receptor; existencia."},
    "„Åß":{yomi:"„Åß",gloss:"lugar de la acci√≥n; medio",pos:"part√≠cula", ro:"de", note:"D√≥nde ocurre la acci√≥n; tambi√©n medio."},
    "„Å∏":{yomi:"„Å∏",gloss:"direcci√≥n (hacia)",pos:"part√≠cula (direcci√≥n)", ro:"e", rov:["he"], note:"Direcci√≥n aproximada; m√°s literario que „Å´."},
    "„Å®":{yomi:"„Å®",gloss:"‚Äòy‚Äô / con; cita",pos:"part√≠cula (conj./cita)", ro:"to", note:"Coordina; marca comillas/cita."},
    "„Åã„Çâ":{yomi:"„Åã„Çâ",gloss:"desde; porque",pos:"part√≠cula (origen/causa)", ro:"kara"},
    "„Åæ„Åß":{yomi:"„Åæ„Åß",gloss:"hasta",pos:"part√≠cula (l√≠mite)", ro:"made"},
    "„Çà„Çä":{yomi:"„Çà„Çä",gloss:"que (comparativo)",pos:"part√≠cula (comparaci√≥n)", ro:"yori"},

    // extra
    "„Åæ„Åæ":{yomi:"„Åæ„Åæ",gloss:"tal cual; en ese estado",pos:"sust. gramatical", ro:"mama", note:"Algo se mantiene ‚Äòtal cual‚Äô."},
    "„ÅÆ„Åæ„Åæ":{yomi:"„ÅÆ „Åæ„Åæ",gloss:"tal como (X) est√°/estaba",pos:"construcci√≥n", ro:"no mama", note:"X „ÅÆ„Åæ„Åæ = ‚Äòtal como X‚Äô, sin cambiar."}
  };
  var DICT_KEYS=Object.keys(JA_DICT).sort(function(a,b){return b.length-a.length;});

  // √≠ndice RO
  var RO_INDEX = {};
  function addRo(surf, entry, r){ if(!r) return; RO_INDEX[norm(r)] = { surface: surf, yomi:entry.yomi, gloss:entry.gloss, note:entry.note||'', ro:r }; }
  Object.keys(JA_DICT).forEach(function(surf){
    var e = JA_DICT[surf]; addRo(surf,e,e.ro);
    if(e.rov){ e.rov.forEach(function(r){ addRo(surf,e,r); }); }
  });

  // ===== segmentaci√≥n JA =====
  var segJA = (typeof Intl!=='undefined' && Intl.Segmenter)? new Intl.Segmenter('ja',{granularity:'word'}) : null;
  function sliceWithDict(line){
    var out=[], i=0;
    while(i<line.length){
      var m=null, k;
      for(var idx=0; idx<DICT_KEYS.length; idx++){ k=DICT_KEYS[idx]; if(line.indexOf(k,i)===i){ m=k; break; } }
      if(m){ var e=JA_DICT[m]; out.push({text:m, dict:e, start:i, end:i+m.length}); i+=m.length; }
      else{ out.push({text:line[i], start:i, end:i+1}); i++; }
    }
    return out;
  }
  function segmentJapanese(line){
    var raw=sliceWithDict(line);
    if(!segJA){ return raw.map(function(p){ return {text:p.text,start:p.start,end:p.end,dict:p.dict||null}; }); }
    var out=[], buffer='', bStart=null;
    function flush(){
      if(!buffer) return;
      var pos=0;
      var it = segJA.segment(buffer);
      for(var seg of it){
        var s=seg.segment;
        var st=bStart + buffer.indexOf(s,pos);
        var en=st+s.length;
        pos = buffer.indexOf(s,pos)+s.length;
        out.push({text:s,start:st,end:en,dict:null});
      }
      buffer=''; bStart=null;
    }
    raw.forEach(function(p){
      if(p.dict){ flush(); out.push({text:p.text,start:p.start,end:p.end,dict:p.dict}); }
      else{ if(buffer===''){ buffer=p.text; bStart=p.start; } else buffer+=p.text; }
    });
    flush(); return out;
  }

  // ===== romaji helpers =====
  var ROMA_MAP = {
    '„Åç„ÇÉ':'kya','„Åç„ÇÖ':'kyu','„Åç„Çá':'kyo','„Åó„ÇÉ':'sha','„Åó„ÇÖ':'shu','„Åó„Çá':'sho','„Å°„ÇÉ':'cha','„Å°„ÇÖ':'chu','„Å°„Çá':'cho',
    '„Å´„ÇÉ':'nya','„Å´„ÇÖ':'nyu','„Å´„Çá':'nyo','„Å≤„ÇÉ':'hya','„Å≤„ÇÖ':'hyu','„Å≤„Çá':'hyo','„Åø„ÇÉ':'mya','„Åø„ÇÖ':'myu','„Åø„Çá':'myo',
    '„Çä„ÇÉ':'rya','„Çä„ÇÖ':'ryu','„Çä„Çá':'ryo','„Åé„ÇÉ':'gya','„Åé„ÇÖ':'gyu','„Åé„Çá':'gyo','„Åò„ÇÉ':'ja','„Åò„ÇÖ':'ju','„Åò„Çá':'jo',
    '„Å≥„ÇÉ':'bya','„Å≥„ÇÖ':'byu','„Å≥„Çá':'byo','„Å¥„ÇÉ':'pya','„Å¥„ÇÖ':'pyu','„Å¥„Çá':'pyo',
    '„ÅÇ':'a','„ÅÑ':'i','„ÅÜ':'u','„Åà':'e','„Åä':'o','„Åã':'ka','„Åç':'ki','„Åè':'ku','„Åë':'ke','„Åì':'ko',
    '„Åï':'sa','„Åó':'shi','„Åô':'su','„Åõ':'se','„Åù':'so','„Åü':'ta','„Å°':'chi','„Å§':'tsu','„Å¶':'te','„Å®':'to',
    '„Å™':'na','„Å´':'ni','„Å¨':'nu','„Å≠':'ne','„ÅÆ':'no','„ÅØ':'ha','„Å≤':'hi','„Åµ':'fu','„Å∏':'he','„Åª':'ho',
    '„Åæ':'ma','„Åø':'mi','„ÇÄ':'mu','„ÇÅ':'me','„ÇÇ':'mo','„ÇÑ':'ya','„ÇÜ':'yu','„Çà':'yo','„Çâ':'ra','„Çä':'ri','„Çã':'ru','„Çå':'re','„Çç':'ro',
    '„Çè':'wa','„Çí':'o','„Çì':'n','„Åå':'ga','„Åé':'gi','„Åê':'gu','„Åí':'ge','„Åî':'go','„Åñ':'za','„Åò':'ji','„Åö':'zu','„Åú':'ze','„Åû':'zo',
    '„Å†':'da','„Å¢':'ji','„Å•':'zu','„Åß':'de','„Å©':'do','„Å∞':'ba','„Å≥':'bi','„Å∂':'bu','„Åπ':'be','„Åº':'bo','„Å±':'pa','„Å¥':'pi','„Å∑':'pu','„Å∫':'pe','„ÅΩ':'po',
    '„ÅÅ':'a','„ÅÉ':'i','„ÅÖ':'u','„Åá':'e','„Åâ':'o','„ÇÉ':'ya','„ÇÖ':'yu','„Çá':'yo','„Å£':'','„Éº':''
  };
  function hiraToRoma(str){
    var out=''; for(var i=0;i<str.length;i++){
      var ch=str[i], next=str[i+1]||'';
      if(ch==='„Å£' && next){ var roma = ROMA_MAP[next] || ''; if(roma) out += roma[0]; continue; }
      var dig=str.slice(i,i+2);
      if(ROMA_MAP[dig]){ out+=ROMA_MAP[dig]; i++; continue; }
      out += ROMA_MAP[ch] || ch;
    }
    return out;
  }

  // ===== render =====
  function renderLine(track, el, mode){
    var show=(state.showJA&&mode==='ja')||(state.showRO&&mode==='ro')||(state.showES&&mode==='es');
    if(!show){ el.hidden=true; el.innerHTML=''; return; }

    var cue=null;
    if(track && track.activeCues && track.activeCues.length) cue=track.activeCues[0];
    else if(track && track.cues && track.cues.length){
      var t=video.currentTime;
      for(var i=0;i<track.cues.length;i++){ var c=track.cues[i]; if(t>=c.startTime && t<=c.endTime){ cue=c; break; } }
    }
    if(!cue){ el.hidden=true; el.innerHTML=''; return; }

    el.hidden=false; el.innerHTML='';
    var lines = cue.text.split(/\r?\n/);
    for(var li=0; li<lines.length; li++){
      var lineText = lines[li];
      if(mode==='ja'){
        var tokens = segmentJapanese(lineText);
        var wrap = document.createElement('span');
        wrap.className='line-ja'; wrap.dataset.text=lineText;
        tokens.forEach(function(tok,idx){
          var sp=document.createElement('span');
          sp.className='word-ja';
          if(state.showFG && tok.dict){ sp.innerHTML = '<ruby><rb>'+tok.text+'</rb><rt>'+tok.dict.yomi+'</rt></ruby>'; }
          else { sp.textContent = tok.text; }
          sp.dataset.word=(tok.text||'').trim();
          sp.dataset.start=tok.start; sp.dataset.end=tok.end; sp.dataset.idx=idx;
          if(tok.dict){
            sp.dataset.dict='1';
            if(tok.dict.yomi) sp.dataset.yomi = tok.dict.yomi;
            if(tok.dict.gloss) sp.dataset.gloss= tok.dict.gloss;
            if(tok.dict.ro)   sp.dataset.roma = tok.dict.ro;
            if(tok.dict.pos)  sp.dataset.pos  = tok.dict.pos;
            if(tok.dict.note) sp.dataset.note = tok.dict.note;
          } else { sp.dataset.dict='0'; }
          wrap.appendChild(sp);
        });
        el.appendChild(wrap);
      } else if(mode==='ro'){
        var parts = lineText.split(/(\s+|[.,!?¬°¬ø‚Ä¶:;()\[\]'"-])/).filter(Boolean);
        var idx=0;
        parts.forEach(function(tok){
          if(/\s+|[.,!?¬°¬ø‚Ä¶:;()\[\]'"-]/.test(tok)){
            el.appendChild(document.createTextNode(tok));
          }else{
            var sp=document.createElement('span');
            sp.className='word-ro';
            sp.textContent=tok;
            sp.dataset.norm = norm(tok);
            sp.dataset.idx = String(idx++);
            sp.style.pointerEvents='auto';
            sp.style.cursor='pointer';
            el.appendChild(sp);
          }
        });
      } else {
        el.appendChild(document.createTextNode(lineText));
      }
      if(li<lines.length-1) el.appendChild(document.createElement('br'));
    }
  }
  function renderCue(){
    renderLine(trkJA?trkJA.track:null,capJA,'ja');
    renderLine(trkRO?trkRO.track:null,capRO,'ro');
    renderLine(trkES?trkES.track:null,capES,'es');
  }
  if(trkJA) trkJA.addEventListener('load', renderCue);
  if(trkRO) trkRO.addEventListener('load', renderCue);
  if(trkES) trkES.addEventListener('load', renderCue);
  video.addEventListener('timeupdate', renderCue);
  video.addEventListener('seeked', renderCue);
  video.addEventListener('ratechange', renderCue);
  window.addEventListener('load', renderCue);

  // ===== highlight RO =====
  var roBadgeEl=null;
  function clearROHighlight(){
    var els = capRO.querySelectorAll('.word-ro.hl'); for(var i=0;i<els.length;i++) els[i].classList.remove('hl');
    if(roBadgeEl && roBadgeEl.parentNode) roBadgeEl.parentNode.removeChild(roBadgeEl);
    roBadgeEl=null;
  }
  function highlightInRO(romaji){
    clearROHighlight();
    if(!state.showRO || !romaji) return;
    var target = norm(romaji);
    var toks = Array.prototype.slice.call(capRO.querySelectorAll('.word-ro'));
    var norms = toks.map(function(t){ return t.dataset.norm||''; });

    // (a) ventana contigua exacta (prioriza PRIMERA)
    for(var i=0;i<norms.length;i++){
      var cat='';
      for(var j=i;j<norms.length;j++){
        cat += norms[j];
        if(cat===target){
          for(var k=i;k<=j;k++) toks[k].classList.add('hl');
          return;
        }
        if(cat.length >= target.length) break;
      }
    }
    // (b) exacto 1 token
    for(i=0;i<norms.length;i++){ if(norms[i]===target){ toks[i].classList.add('hl'); return; } }
    // (c) inclusi√≥n ‚Äî primera m√°s larga
    var pick=-1, bestLen=0;
    for(i=0;i<norms.length;i++){
      var n=norms[i];
      if(n.indexOf(target)!==-1 || target.indexOf(n)!==-1){
        if(bestLen===0 || n.length>bestLen){ pick=i; bestLen=n.length; }
        if(bestLen===target.length) break;
      }
    }
    if(pick!==-1){ toks[pick].classList.add('hl'); return; }

    // (d) sugerencia
    roBadgeEl=document.createElement('span');
    roBadgeEl.className='ro-badge';
    roBadgeEl.textContent=romaji;
    capRO.appendChild(roBadgeEl);
  }

  // ===== popover helpers =====
  function longestDictAt(line, pos){
    var best=null;
    for(var di=0; di<DICT_KEYS.length; di++){
      var k=DICT_KEYS[di], i=line.indexOf(k);
      if(i!==-1 && i<=pos && pos<i+k.length){
        if(!best || k.length>best.text.length) best={text:k,start:i,end:i+k.length,entry:JA_DICT[k]};
      }
    }
    return best;
  }
  function showPopover(x, y, entry, surface){
    if(!pop) return;
    pvWord.textContent = surface||'‚Äî';
    pvRead.textContent = 'Lectura: ' + (entry&&entry.yomi || '‚Äî');
    pvMeaning.textContent = 'Significado: ' + (entry&&entry.gloss || '‚Äî') + ((entry&&entry.note)? ' ‚Äî '+entry.note : '');
    var rect=player.getBoundingClientRect();
    pop.style.display='block';
    pop.style.left=(Math.min(rect.width-10, Math.max(10, x - rect.left + 8)))+'px';
    pop.style.top =(Math.min(rect.height-10, Math.max(10, y - rect.top  + 8)) - 10)+'px';
  }

  // hover JA -> RO
  document.addEventListener('mousemove', function(e){
    if(!state.showJA || !capJA.contains(e.target)) return;
    var span = e.target.closest ? e.target.closest('.word-ja') : null; if(!span){ clearROHighlight(); return; }
    var reading = span.dataset.yomi || '';
    var romaji  = span.dataset.roma || '';
    var txt = span.textContent || '';
    if(!reading && /[\u3040-\u309f]/.test(txt)){ reading = txt; }
    if(!romaji && reading){ romaji = hiraToRoma(reading); }
    if(romaji){ highlightInRO(romaji); } else { clearROHighlight(); }
  }, true);
  document.addEventListener('mouseleave', function(){ clearROHighlight(); }, true);

  // click JA -> popover + sync RO
  document.addEventListener('click', function(e){
    if(!state.showJA) return;
    if(!capJA.contains(e.target)){ if(!e.target.closest || !e.target.closest('#popover')) pop.style.display='none'; return; }
    var span = e.target.closest ? e.target.closest('.word-ja') : null; if(!span) return;
    var wrap = span.closest ? span.closest('.line-ja') : null;
    var lineText = wrap ? (wrap.dataset.text||'') : '';
    var start = Number(span.dataset.start)||0, end=Number(span.dataset.end)||start+(span.textContent||'').length;
    var pos = Math.floor((start+end)/2);

    var surface = span.dataset.word || span.textContent;
    var entry = (span.dataset.dict==='1') ? {yomi:span.dataset.yomi, gloss:span.dataset.gloss, ro:span.dataset.roma, note:span.dataset.note} : null;
    if(!entry){ var best=longestDictAt(lineText, pos); if(best){ surface=best.text; var be=best.entry; entry={yomi:be.yomi,gloss:be.gloss,ro:be.ro,note:be.note}; } }

    showPopover(e.clientX, e.clientY, entry, surface);
    var romaOut = (entry&&entry.ro) ? entry.ro : ((entry&&entry.yomi)?hiraToRoma(entry.yomi):'');
    if(romaOut) highlightInRO(romaOut);
  }, true);

  // click RO -> popover si JA activo
  if(capRO){
    capRO.addEventListener('click', function(e){
      if(!state.showJA) return;
      var sp = e.target.closest ? e.target.closest('.word-ro') : null; if(!sp) return;

      var toks = Array.prototype.slice.call(capRO.querySelectorAll('.word-ro'));
      var norms = toks.map(function(t){ return t.dataset.norm||''; });
      var idx   = toks.indexOf(sp);

      var best=null, maxLen=4;
      for(var len=maxLen; len>=1; len--){
        if(idx+len-1 >= toks.length) continue;
        var cat='', j; for(j=0;j<len;j++) cat += norms[idx+j];
        if(RO_INDEX[cat]){ best={ entry:RO_INDEX[cat], i0:idx, i1:idx+len-1 }; break; }
      }
      if(!best){
        for(var back=1; back<=3 && idx-back>=0 && !best; back++){
          for(len=2; len<=maxLen && idx-back+len-1<toks.length; len++){
            cat=''; for(j=0;j<len;j++) cat += norms[idx-back+j];
            if(RO_INDEX[cat]){ best={ entry:RO_INDEX[cat], i0:idx-back, i1:idx-back+len-1 }; break; }
          }
        }
      }
      if(!best) return;

      var ent = best.entry;
      showPopover(e.clientX, e.clientY, ent, ent.surface);
      highlightInRO(ent.ro);
    });
  }

  // herramientas
  var btnTest=$('#btnTest'), btnURL=$('#btnURL');
  if(btnTest) btnTest.addEventListener('click', function(){ setSrc('https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'); log('Cargando video de prueba MDN'); });
  if(btnURL)  btnURL .addEventListener('click', function(){ var u=prompt('Peg√° una URL directa a .mp4 (https://...)'); if(!u) return; setSrc(u.trim()); log('Cambi√© src a '+u); });

  // atajos
  document.addEventListener('keydown', function(e){
    if(e.key==='j' || e.key==='J'){ if(togJA) togJA.click(); }
    if(e.key==='a' || e.key==='A'){ if(togRO) togRO.click(); }
    if(e.key==='e' || e.key==='E'){ if(togES) togES.click(); }
    if(e.key==='g' || e.key==='G'){ if(togFG) togFG.click(); }
  });

  // info inicial
  log('script cargado; JA/RO/ES listos');
})();
</script>
