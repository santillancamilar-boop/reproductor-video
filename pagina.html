<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reproductor DBZ ‚Äî Pages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#f6f7fb; --ink:#2d2a32; --muted:#6b6a73; --panel:#ffffff; --edge:#e9e8f2; --accent:#b59bff; }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--ink);
      background:
        radial-gradient(1000px 1000px at 10% -10%, #efeaff 0%, transparent 55%),
        radial-gradient(900px 900px at 100% 0%, #e3fff7 0%, transparent 55%),
        linear-gradient(180deg,var(--bg),#fdfcff 60%);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .player{ background:var(--panel); border:1px solid var(--edge); border-radius:22px; box-shadow:0 10px 30px rgba(23,15,41,.08); max-width:960px; width:100% }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px;
      background:linear-gradient(135deg, color-mix(in oklch,var(--accent), white 20%), color-mix(in oklch,var(--accent), black 8%)); color:#2b223d }
    .title{ margin:0; font-size:16px; font-weight:700; letter-spacing:.3px }
    .badge{ font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.65); border:1px solid rgba(0,0,0,.05) }

    .stage{ position:relative; background:#000 }
    video{ width:100%; height:auto; display:block; background:#000; position:relative; z-index:1 }
    .center-play{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none }
    .center-play .btn-big{ pointer-events:auto; --size:72px; width:var(--size); height:var(--size); border-radius:999px; border:none; display:grid; place-items:center; font-size:28px; color:white; background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.45)); box-shadow:0 10px 30px rgba(0,0,0,.2) }

    .controls{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:14px 16px; padding:14px 16px 12px }
    .row{ display:flex; align-items:center; gap:8px }
    .btn{ --size:40px; width:var(--size); height:var(--size); display:grid; place-items:center; border-radius:12px; border:1px solid var(--edge); background:linear-gradient(180deg,#fff,#fafafe); box-shadow:0 6px 16px rgba(23,15,41,.08); cursor:pointer; color:var(--ink) }
    .btn[aria-pressed="true"]{ outline:2px solid color-mix(in oklch,var(--accent),white 15%) }

    .seek{ grid-column:1/-1; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px }
    .time{ font-variant-numeric:tabular-nums; color:var(--muted); font-size:14px; min-width:70px; text-align:center }
    .range{ position:relative; height:22px; display:grid; align-items:center }
    .buffered,.progress{ pointer-events:none; position:absolute; left:0; height:4px; border-radius:999px }
    .buffered{ width:0%; background:#e8e7f4 } .progress{ width:0%; background:var(--accent) }
    input[type="range"].slider{-webkit-appearance:none; appearance:none; width:100%; height:4px; background:transparent; outline:none}
    input[type="range"].slider::-webkit-slider-thumb{-webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:white; border:2px solid var(--accent); box-shadow:0 2px 6px rgba(0,0,0,.12); margin-top:-6px}
    .vol{width:min(180px,25vw)}
    input[type="range"].vol-slider{-webkit-appearance:none; appearance:none; width:100%; height:4px; background:#efeef8; border-radius:999px}
    input[type="range"].vol-slider::-webkit-slider-thumb{ width:14px; height:14px; border-radius:50%; background:var(--accent) }

    .select{ padding:8px 10px; border-radius:12px; border:1px solid var(--edge); background:linear-gradient(180deg,#fff,#fafafe); color:var(--ink) }
    .foot{ color:var(--muted); font-size:13px; padding:0 16px 16px }

    /* Subt√≠tulos overlay */
    .captions{ position:absolute; left:0; right:0; bottom:6%; display:flex; flex-direction:column; gap:6px; align-items:center; padding:0 12px; z-index:5; pointer-events:auto }
    .cap-line{ max-width:min(86%, 900px); width:fit-content; color:#111; font-weight:600; letter-spacing:.2px; line-height:1.35; border-radius:14px; padding:8px 12px; box-shadow:0 6px 20px rgba(0,0,0,.16) }
    .track-ja{ background:rgba(255,255,255,.92) }
    .track-romaji{ background:rgba(255,245,232,.95) }
    .track-es{ background:rgba(236,253,245,.95) }

    /* Solo japon√©s es clickeable */
    .word-ja{ cursor:pointer; padding:0 2px; border-radius:6px }
    .word-ja:hover{ background:rgba(0,0,0,.06) }
    .track-romaji .word, .track-es .word{ pointer-events:none; cursor:default }

    /* Popover (JA) */
    .popover{ position:absolute; z-index:10; min-width:240px; max-width:360px; background:#fff; border:1px solid var(--edge); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.15); padding:10px 12px; display:none }
    .popover .word{ font-weight:800; font-size:18px }
    .popover .hint{ color:var(--muted); font-size:12px; margin-top:4px }
    .popover .meaning{ margin-top:6px }
    .popover .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
    .chip-btn{ border:1px solid var(--edge); background:linear-gradient(180deg,#fff,#fafafe); padding:6px 10px; border-radius:10px; cursor:pointer }
  </style>
</head>
<body>
  <div class="player" id="player">
    <div class="header">
      <h1 class="title">Proyecto integral ‚Äî Reproductor</h1>
      <span class="badge" id="badgeDur">00:00</span>
    </div>

    <div class="stage">
      <video id="video" preload="metadata" playsinline webkit-playsinline poster="poster.jpg">
        <source id="src" src="video.mp4" type="video/mp4" />
        <!-- Pistas (mismo origen). JA por defecto -->
        <track id="trk-ja" label="Êó•Êú¨Ë™û"   kind="subtitles" srclang="ja"      src="subs-ja.vtt" default />
        <track id="trk-ro" label="R≈çmaji"  kind="subtitles" srclang="ja-Latn" src="subs-ro.vtt" />
        <track id="trk-es" label="Espa√±ol" kind="subtitles" srclang="es"      src="subs-es.vtt" />
        Tu navegador no soporta la etiqueta <code>video</code>.
      </video>

      <div class="center-play"><button class="btn-big" id="bigPlay" title="Reproducir">‚ñ∂</button></div>

      <div class="captions" id="captions">
        <div class="cap-line track-ja"     id="cap-ja" hidden></div>
        <div class="cap-line track-romaji" id="cap-romaji" hidden></div>
        <div class="cap-line track-es"     id="cap-es" hidden></div>
      </div>

      <!-- Popover (solo JA) -->
      <div class="popover" id="popover">
        <div><span class="word" id="pv-word">‚Äî</span></div>
        <div class="hint" id="pv-reading"></div>
        <div class="meaning" id="pv-meaning"></div>
        <div class="actions">
          <button class="chip-btn" id="pv-copy">Copiar</button>
          <button class="chip-btn" id="pv-google">Buscar</button>
          <button class="chip-btn" id="pv-jisho">Jisho</button>
          <button class="chip-btn" id="pv-close">Cerrar</button>
        </div>
      </div>
    </div>

    <div class="controls" role="group" aria-label="Controles">
      <div class="row">
        <button class="btn" id="back10" title="Retroceder 10s">‚ü≤</button>
        <button class="btn" id="play"   title="Reproducir/Pausar"><span id="icon-play">‚ñ∂</span></button>
        <button class="btn" id="fwd10"  title="Avanzar 10s">‚ü≥</button>
      </div>
      <div class="row seek" aria-label="Barra de progreso">
        <div class="time" id="currentTime">0:00</div>
        <div class="range">
          <div class="buffered" id="bufferedBar"></div>
          <div class="progress" id="progressBar"></div>
          <input id="seek" class="slider" type="range" min="0" max="1000" step="1" value="0" />
        </div>
        <div class="time" id="duration">0:00</div>
      </div>
      <div class="row">
        <button class="btn" id="mute" title="Silenciar/Activar">üîä</button>
        <div class="vol"><input id="volume" class="vol-slider" type="range" min="0" max="1" step="0.01" value="1" /></div>
      </div>
      <div class="row">
        <select id="speed" class="select" aria-label="Velocidad">
          <option value="0.5">0.5√ó</option><option value="0.75">0.75√ó</option><option value="1" selected>1√ó</option>
          <option value="1.25">1.25√ó</option><option value="1.5">1.5√ó</option><option value="1.75">1.75√ó</option><option value="2">2√ó</option>
        </select>
        <!-- Independientes: se pueden combinar -->
        <button class="btn" id="tog-ja"      aria-pressed="true">JA</button>
        <button class="btn" id="tog-romaji"  aria-pressed="false">RO</button>
        <button class="btn" id="tog-es"      aria-pressed="false">ES</button>
        <button class="btn" id="fs"          title="Pantalla completa (F)">‚§¢</button>
      </div>
    </div>

    <div class="tools">
      <button class="btn" id="btnTest">Probar video de prueba (MDN)</button>
      <button class="btn" id="btnURL">Cargar por URL‚Ä¶</button>
      <span class="pill" id="statusSrc">src: video.mp4</span>
      <span class="pill" id="pillJA">JA: ‚Äî</span>
      <span class="pill" id="pillRO">RO: ‚Äî</span>
      <span class="pill" id="pillES">ES: ‚Äî</span>
    </div>
    <div class="diag" id="diag"></div>

    <div class="foot">Atajos: Espacio ¬∑ ‚Üê/‚Üí ¬±5s ¬∑ ‚Üë/‚Üì volumen ¬∑ M mute ¬∑ F pantalla completa ¬∑ J/A/E alternar JA/RO/ES</div>
  </div>

  <script>
    (function(){
      const $=(s)=>document.querySelector(s);
      const player=$('#player'), video=$('#video'), srcEl=$('#src');
      const bigPlay=$('#bigPlay'), playBtn=$('#play'), iconPlay=$('#icon-play');
      const back10=$('#back10'), fwd10=$('#fwd10'), seek=$('#seek'), progressBar=$('#progressBar'), bufferedBar=$('#bufferedBar');
      const cur=$('#currentTime'), dur=$('#duration'), muteBtn=$('#mute'), vol=$('#volume'), speed=$('#speed'), fs=$('#fs'), badgeDur=$('#badgeDur');
      const diag=$('#diag'), statusSrc=$('#statusSrc');
      const pillJA=$('#pillJA'), pillRO=$('#pillRO'), pillES=$('#pillES');

      /* ===== Peque√±o diccionario local (palabra ‚Üí lectura, significado) ===== */
      const JA_DICT = {
        "Â≠´ÊÇüÈ£Ø":   { yomi:"„Åù„Çì„Åî„ÅØ„Çì", gloss:"Son Gohan (nombre propio)" },
        "Ê≠£„Åó„ÅÑ":   { yomi:"„Åü„Å†„Åó„ÅÑ", gloss:"correcto; justo" },
        "„Åü„ÇÅ„Å´":   { yomi:"„Åü„ÇÅ„Å´", gloss:"para; por el bien de" },
        "Êà¶„ÅÜ":     { yomi:"„Åü„Åü„Åã„ÅÜ", gloss:"pelear; luchar" },
        "ÁΩ™":       { yomi:"„Å§„Åø", gloss:"pecado; culpa" },
        "„Åß„ÅØ„Å™„ÅÑ": { yomi:"„Åß„ÅØ„Å™„ÅÑ", gloss:"no es; no ser" },
        "Ë©±„ÅóÂêà„ÅÑ": { yomi:"„ÅØ„Å™„Åó„ÅÇ„ÅÑ", gloss:"di√°logo; discusi√≥n" },
        "ÈÄöÁî®„Åó„Å™„ÅÑ": { yomi:"„Å§„ÅÜ„Çà„ÅÜ„Åó„Å™„ÅÑ", gloss:"no funciona; no surte efecto" },
        "Áõ∏Êâã":     { yomi:"„ÅÇ„ÅÑ„Å¶", gloss:"oponente; interlocutor" },
        "Á≤æÁ•û":     { yomi:"„Åõ„ÅÑ„Åó„Çì", gloss:"esp√≠ritu; mente" },
        "ÂÖâ":       { yomi:"„Å≤„Åã„Çä", gloss:"luz" },
        "Ëá™Áî±„Å´":   { yomi:"„Åò„ÇÜ„ÅÜ„Å´", gloss:"libremente" },
        "Ëß£Êîæ„Åó„Å¶„ÇÑ„Çå": { yomi:"„Åã„ÅÑ„Åª„ÅÜ„Åó„Å¶„ÇÑ„Çå", gloss:"d√©jalo/lib√©ralo" },
        "Ê∞óÊåÅ„Å°":   { yomi:"„Åç„ÇÇ„Å°", gloss:"sentimiento" },
        "ÂàÜ„Åã„Çã":   { yomi:"„Çè„Åã„Çã", gloss:"entender" },
        "„ÇÇ„ÅÜ":     { yomi:"„ÇÇ„ÅÜ", gloss:"ya; m√°s" },
        "ÊàëÊÖ¢„Åô„Çã": { yomi:"„Åå„Åæ„Çì„Åô„Çã", gloss:"aguantarse; soportar" },
        "„Åì„Å®„ÅØ„Å™„ÅÑ": { yomi:"„Åì„Å®„ÅØ„Å™„ÅÑ", gloss:"no es necesario; no hace falta" }
      };
      const DICT_KEYS_DESC = Object.keys(JA_DICT).sort((a,b)=>b.length-a.length); // para buscar coincidencia m√°s larga

      function log(msg){ diag.innerHTML=`[${new Date().toLocaleTimeString()}] ${msg}<br>`+diag.innerHTML; }
      function setSrc(url){ srcEl.src=url; statusSrc.textContent='src: '+url; video.load(); }

      // Duraci√≥n / estado
      function formatTime(s){ if(!isFinite(s)) return '0:00'; const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=String(Math.floor(s%60)).padStart(2,'0'); return (h>0? h+':'+String(m).padStart(2,'0'):m)+':'+sec; }
      video.addEventListener('loadedmetadata',()=>{ dur.textContent=formatTime(video.duration); badgeDur.textContent=formatTime(video.duration); updateBuffered(); log('loadedmetadata OK'); });
      ["canplay","canplaythrough","stalled","waiting","suspend"].forEach(ev=>video.addEventListener(ev,()=>log(ev)));
      video.addEventListener('error',()=>{ const code=video.error?video.error.code:'?'; log('ERROR VIDEO code='+code); });

      // Controles b√°sicos
      function togglePlay(){ (video.paused||video.ended)?video.play():video.pause(); }
      [playBtn, video, bigPlay].forEach(el=>el.addEventListener('click', togglePlay));
      video.addEventListener('play', ()=>{ iconPlay.textContent='‚è∏'; bigPlay.style.display='none'; });
      video.addEventListener('pause', ()=>{ iconPlay.textContent='‚ñ∂';  bigPlay.style.display='grid'; });

      back10.addEventListener('click', ()=> video.currentTime=Math.max(0,(video.currentTime||0)-10));
      fwd10 .addEventListener('click', ()=> video.currentTime=Math.min(video.duration||0,(video.currentTime||0)+10));
      function updateTime(){ cur.textContent=formatTime(video.currentTime); const pct=(video.currentTime/(video.duration||1))*100; progressBar.style.width=pct+'%'; seek.value=Math.round((video.currentTime/(video.duration||1))*1000)||0; }
      function updateBuffered(){ try{ if(video.buffered && video.buffered.length){ const end=video.buffered.end(video.buffered.length-1); bufferedBar.style.width=((end/(video.duration||1))*100)+'%'; } }catch(e){}
      }
      video.addEventListener('timeupdate', updateTime);
      video.addEventListener('progress', updateBuffered);
      video.addEventListener('loadeddata', updateBuffered);
      seek.addEventListener('input', ()=>{ video.currentTime=(seek.value/1000)*(video.duration||0); updateTime(); });

      function updateMuteIcon(){ const level=video.muted||video.volume===0?0:video.volume; muteBtn.textContent= level===0?'üîá':(level<.5?'üîà':'üîä'); }
      vol.addEventListener('input', ()=>{ video.volume=Number(vol.value); if(video.volume>0) video.muted=false; updateMuteIcon(); });
      muteBtn.addEventListener('click', ()=>{ video.muted=!video.muted; updateMuteIcon(); });
      video.addEventListener('volumechange', updateMuteIcon); updateMuteIcon();

      speed.addEventListener('change', ()=>{ video.playbackRate=Number(speed.value); });
      function toggleFS(){ if(document.fullscreenElement) document.exitFullscreen(); else player.requestFullscreen().catch(()=>{}); }
      fs.addEventListener('click', toggleFS);

      // Pistas y overlay
      const capJA=$('#cap-ja'), capRO=$('#cap-romaji'), capES=$('#cap-es');
      const trkJA=$('#trk-ja'), trkRO=$('#trk-ro'), trkES=$('#trk-es');
      const togJA=$('#tog-ja'), togRO=$('#tog-romaji'), togES=$('#tog-es');
      const tracks={ ja:trkJA?.track||null, ro:trkRO?.track||null, es:trkES?.track||null };
      Object.values(tracks).forEach(t=>{ if(t){ try{ t.mode='hidden'; }catch(_){}});

      function armTrack(el,name,pill){
        if(!el){ pill.textContent=`${name.toUpperCase()}: ‚Äî`; log(`TRACK ${name}: (no existe en HTML)`); return; }
        const t=el.track;
        function ok(){ pill.textContent=`${name.toUpperCase()}: ok (${t.cues?t.cues.length:0})`; log(`TRACK ${name}: loaded`); renderCue(); }
        function err(){ pill.textContent=`${name.toUpperCase()}: error`; log(`TRACK ${name}: error (archivo/ruta/WEBVTT)`); }
        if(el.readyState===2) ok(); else{ el.addEventListener('load',ok,{once:true}); el.addEventListener('error',err,{once:true}); }
      }
      armTrack(trkJA,'ja',pillJA); armTrack(trkRO,'ro',pillRO); armTrack(trkES,'es',pillES);

      // Estado (combinable)
      const state={ showJA:true, showRO:false, showES:false };
      function setToggle(btn,on){ btn.setAttribute('aria-pressed', on); }
      function syncToggles(){ setToggle(togJA,state.showJA); setToggle(togRO,state.showRO); setToggle(togES,state.showES); }
      syncToggles();
      togJA.addEventListener('click', ()=>{ state.showJA=!state.showJA; syncToggles(); renderCue(); });
      togRO.addEventListener('click', ()=>{ state.showRO=!state.showRO; syncToggles(); renderCue(); });
      togES.addEventListener('click', ()=>{ state.showES=!state.showES; syncToggles(); renderCue(); });

      /* === Segmentaci√≥n de palabras (JA) === */
      const segJA = (typeof Intl!=='undefined' && Intl.Segmenter) ? new Intl.Segmenter('ja',{granularity:'word'}) : null;
      const JA_FALLBACK_RE=/[\u3400-\u4DBF\u4E00-\u9FFF]+|[\u3040-\u309F]+|[\u30A0-\u30FF]+|[A-Za-z0-9]+|[^\s]/g;

      function tokenizeJAWithOffsets(line){
        const tokens=[];
        if(!line) return tokens;
        if(segJA){
          let pos=0;
          for(const it of segJA.segment(line)){
            const text=it.segment;
            const start=line.indexOf(text,pos);
            const end=start+text.length;
            pos=end;
            tokens.push({text, start, end, wordLike: !!it.isWordLike});
          }
        }else{
          let m, re=new RegExp(JA_FALLBACK_RE, 'g');
          while((m=re.exec(line))){ tokens.push({text:m[0], start:m.index, end:m.index+m[0].length, wordLike:true}); }
        }
        return tokens;
      }

      function tokenizeLine(line, mode){
        if(mode==='ja') return tokenizeJAWithOffsets(line);
        // RO/ES ‚Äî no clickeables
        const parts = (line.match(/[^ \t\n\r.,!?Ôºå„ÄÇÔºÅ‚Äù‚Äú"'‚Ä¶Ôºö:Ôºõ;\-‚Äî‚Äî()\[\]]+|[.,!?Ôºå„ÄÇÔºÅ‚Äù‚Äú"'‚Ä¶Ôºö:Ôºõ;\-‚Äî‚Äî()\[\]]|\s+/g) || []);
        let pos=0, out=[];
        for(const t of parts){
          const i=line.indexOf(t,pos); out.push({text:t,start:i,end:i+t.length,wordLike:false}); pos=i+t.length;
        }
        return out;
      }

      function renderLine(track, el, mode){
        const show=(state.showJA&&mode==='ja')||(state.showRO&&mode==='ro')||(state.showES&&mode==='es');
        if(!show){ el.hidden=true; el.innerHTML=''; return; }

        // Cue activa
        let cue=null;
        if(track?.activeCues?.length) cue=track.activeCues[0];
        else if(track?.cues?.length){
          const t=video.currentTime;
          for(let i=0;i<track.cues.length;i++){ const c=track.cues[i]; if(t>=c.startTime && t<=c.endTime){ cue=c; break; } }
        }
        if(!cue){ el.hidden=true; el.innerHTML=''; return; }

        // Render
        el.hidden=false; el.innerHTML='';
        const lines = cue.text.split(/\r?\n/);
        // Para clicks: guardo la l√≠nea completa en data
        el.dataset.line = lines[0] || '';

        // Construcci√≥n
        for(let li=0; li<lines.length; li++){
          const parts = tokenizeLine(lines[li], mode);
          const frag=document.createDocumentFragment();
          for(const p of parts){
            if(mode==='ja' && p.wordLike){
              const sp=document.createElement('span');
              sp.className='word-ja';
              sp.textContent=p.text;
              sp.dataset.word=p.text.trim();
              sp.dataset.start=p.start; sp.dataset.end=p.end;
              frag.appendChild(sp);
            }else{
              frag.appendChild(document.createTextNode(p.text));
            }
          }
          el.appendChild(frag);
          if(li<lines.length-1) el.appendChild(document.createElement('br'));
        }
      }

      function renderCue(){ renderLine(tracks.ja,capJA,'ja'); renderLine(tracks.ro,capRO,'ro'); renderLine(tracks.es,capES,'es'); }
      Object.values(tracks).forEach(t=>{ t && t.addEventListener('cuechange', renderCue); });
      ["timeupdate","seeked","ratechange"].forEach(ev=>video.addEventListener(ev, renderCue));
      window.addEventListener('load', renderCue);

      /* === Popover: SOLO japon√©s y ‚Äúpalabra completa‚Äù (con expansi√≥n al match m√°s largo del diccionario) === */
      const pop=$('#popover'), pvWord=$('#pv-word'), pvReading=$('#pv-reading'), pvMeaning=$('#pv-meaning');
      $('#pv-close').addEventListener('click', ()=> pop.style.display='none');
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') pop.style.display='none'; });
      document.addEventListener('click',(e)=>{ if(!e.target.closest('#popover') && !e.target.closest('#captions')) pop.style.display='none'; }, true);

      function bestDictMatchFromSpans(spans, idx){
        // Devuelve {text, startIdx, endIdx, entry} intentando el match M√ÅS LARGO del diccionario
        let best=null;
        for(let s=Math.max(0, idx-4); s<=idx; s++){
          for(let e=idx; e<Math.min(spans.length, s+6); e++){
            const phrase = Array.from(spans).slice(s,e+1).map(x=>x.textContent).join('');
            if(JA_DICT[phrase]){
              if(!best || phrase.length > best.text.length){
                best = { text:phrase, startIdx:s, endIdx:e, entry:JA_DICT[phrase] };
              }
            }
          }
        }
        return best;
      }

      document.addEventListener('click',(e)=>{
        if(!state.showJA) return;
        if(!capJA.contains(e.target)) return;
        const span = e.target.closest('.word-ja'); if(!span) return;

        const spans = capJA.querySelectorAll('.word-ja');
        const idx = Array.from(spans).indexOf(span);

        // Intento ampliar al match m√°s largo del diccionario (por ej. ÈÄöÁî®„Åó„Å™„ÅÑ / „Åì„Å®„ÅØ„Å™„ÅÑ / Ëß£Êîæ„Åó„Å¶„ÇÑ„Çå)
        const best = bestDictMatchFromSpans(spans, idx);
        const surface = best ? best.text : (span.dataset.word || span.textContent);

        pvWord.textContent = surface;
        const entry = best ? best.entry : JA_DICT[surface];

        pvReading.textContent = entry ? `Lectura: ${entry.yomi}` : 'Lectura: ‚Äî';
        pvMeaning.textContent = entry ? `Significado: ${entry.gloss}` : 'Significado: (sin entrada en diccionario)';

        const rect=player.getBoundingClientRect();
        pop.style.display='block';
        pop.style.left=(Math.min(rect.width-10, Math.max(10, e.clientX - rect.left + 8)))+'px';
        pop.style.top =(Math.min(rect.height-10, Math.max(10, e.clientY - rect.top + 8)) - 10)+'px';

        // Acciones
        const q = encodeURIComponent(surface.trim());
        $('#pv-copy').onclick = async()=>{ try{ await navigator.clipboard.writeText(surface); pvMeaning.textContent = (entry?`Significado: ${entry.gloss}`:'Copiado'); }catch{} };
        $('#pv-google').onclick = ()=> window.open(`https://www.google.com/search?q=${q}`,'_blank');
        $('#pv-jisho').onclick  = ()=> window.open(`https://jisho.org/search/${q}`,'_blank');
      }, true);

      // Herramientas y atajos
      $('#btnTest').addEventListener('click', ()=>{ setSrc('https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'); log('Cargando video de prueba MDN'); });
      $('#btnURL').addEventListener('click', ()=>{ const u=prompt('Peg√° una URL directa a .mp4 (https://...)'); if(!u) return; setSrc(u.trim()); log('Cambi√© src a '+u); });
      document.addEventListener('keydown',(e)=>{ if(e.key==='j'||e.key==='J'){togJA.click()} if(e.key==='a'||e.key==='A'){togRO.click()} if(e.key==='e'||e.key==='E'){togES.click()} });
    })();
  </script>
</body>
</html>


